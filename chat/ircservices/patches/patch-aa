$NetBSD: patch-aa,v 1.1 2003/05/25 21:03:26 jmc Exp $

--- configure.orig	Thu Apr 10 01:35:14 2003
+++ configure	Sun May 25 20:58:51 2003
@@ -1012,10 +1012,10 @@
 	    cat >tmp/test-lib.c <<EOT
 		int foo() {no_such_symbol();}
 EOT
-	    if run $CC $CC_FLAGS $CC_LIBS tmp/test-dlopen.c -o tmp/test ; then
+	    if run $CC -fPIC $CC_FLAGS $CC_LIBS tmp/test-dlopen.c -o tmp/test ; then
 		CC_DYN_LIBS=""
 		log "dlopen() found (no libs)"
-	    elif run $CC $CC_FLAGS $CC_LIBS tmp/test-dlopen.c -ldl -o tmp/test
+	    elif run $CC -fPIC $CC_FLAGS $CC_LIBS tmp/test-dlopen.c -ldl -o tmp/test
 	    then
 		CC_DYN_LIBS=" -ldl"
 		log "dlopen() found (libdl)"
@@ -1024,7 +1024,7 @@
 		OK=
 	    fi
 	    if [ "$OK" ] ; then
-		if run $CC -rdynamic $CC_FLAGS $CC_LIBS $CC_DYN_LIBS tmp/test-dlopen.c -o tmp/test ; then
+		if run $CC -rdynamic -fPIC $CC_FLAGS $CC_LIBS $CC_DYN_LIBS tmp/test-dlopen.c -o tmp/test ; then
 		    log "-rdynamic works"
 		    CC_DYN_LFLAGS=" -rdynamic"
 		else
@@ -1038,7 +1038,7 @@
 		else
 		    CC_SHARED="$CC -shared"
 		fi
-		if run $CC_SHARED $CC_FLAGS $CC_LIBS tmp/test-lib.c -o tmp/test-lib.so ; then
+		if run $CC_SHARED -fPIC $CC_FLAGS $CC_LIBS tmp/test-lib.c -o tmp/test-lib.so ; then
 		    log "-shared works"
 		else
 		    log "no -shared, aborting dlfcn test"
@@ -1076,8 +1076,8 @@
 			return quux(bar)*2;
 		    }
 EOT
-		if run $CC_SHARED $CC_FLAGS $CC_LIBS tmp/test-dynamic.c -o tmp/test.so \
-		&& run $CC $CC_FLAGS $CC_DYN_LFLAGS $CC_LIBS $CC_DYN_LIBS tmp/test-dynamic2.c tmp/test.so -o tmp/test
+		if run $CC_SHARED -fPIC $CC_FLAGS $CC_LIBS tmp/test-dynamic.c -o tmp/test.so \
+		&& run $CC -fPIC $CC_FLAGS $CC_DYN_LFLAGS $CC_LIBS $CC_DYN_LIBS tmp/test-dynamic2.c tmp/test.so -o tmp/test
 		then
 		    a=`tmp/test 1`
 		    log "symbol resolution test: tmp/test 1 => $a"
@@ -1106,7 +1106,7 @@
 		}
 		int quux(int x) {return x;}
 EOT
-	    if run $CC $CC_FLAGS $CC_DYN_LFLAGS $CC_LIBS $CC_DYN_LIBS tmp/test-dynamic2.c tmp/test.so -o tmp/test
+	    if run $CC -fPIC $CC_FLAGS $CC_DYN_LFLAGS $CC_LIBS $CC_DYN_LIBS tmp/test-dynamic2.c tmp/test.so -o tmp/test
 	    then
 		a=`tmp/test`
 		log "underscore test: tmp/test => $a"
@@ -1130,6 +1130,7 @@
 	if [ "$OK" ] ; then
 	    echo "yes."
 	    STATIC_MODULES=0
+            CC_FLAGS="-fPIC $CC_FLAGS"
 	else
 	    log "static modules selected"
 	    echo "no."
