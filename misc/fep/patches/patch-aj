$NetBSD: patch-aj,v 1.5 2005/09/13 19:40:59 christos Exp $

--- fep_main.c.orig	1993-06-09 22:53:06.000000000 -0400
+++ fep_main.c	2005-09-13 15:38:02.000000000 -0400
@@ -6 +6 @@
-#endif lint
+#endif /* lint */
@@ -13 +13,8 @@
-#include <sys/file.h>
+#ifdef TERMIOS
+#include <stdlib.h>
+#include <fcntl.h>
+#include <termios.h>
+#ifndef _POSIX_VDISABLE
+#define _POSIX_VDISABLE '\0'
+#endif
+#else
@@ -14,0 +22,2 @@
+#include <sys/file.h>
+#endif
@@ -33 +42 @@
-#endif lint
+#endif /* lint */
@@ -41,3 +50,3 @@
-int	mastermask;			/* 1<<master */
-int	stdinmask;			/* 1<<fileno(stdin) */
-int	selectmask;			/* stdinmask | mastermask */
+fd_set	mastermask;			/* 1<<master */
+fd_set	stdinmask;			/* 1<<fileno(stdin) */
+fd_set	selectmask;			/* stdinmask | mastermask */
@@ -51 +60 @@
-int	catchsig();			/* function take care SIGCHILD */
+void	catchsig __P((int));		/* function take care SIGCHILD */
@@ -53,3 +62,8 @@
-struct	sgttyb initial_ttymode;		/* initial tty mode */
-struct	sgttyb master_ttymode;		/* master tty mode */
-struct	sgttyb slave_ttymode;		/* slave tty mode */
+#ifdef TERMIOS
+#define ttystruct termios
+#elif defined(TIOCSETN)
+#define ttystruct sgttyb
+#endif
+struct	ttystruct initial_ttymode;		/* initial tty mode */
+struct	ttystruct master_ttymode;		/* master tty mode */
+struct	ttystruct slave_ttymode;		/* slave tty mode */
@@ -61 +75 @@
-void	(*sighup)(), (*sigchld)(), (*sigtstp)();
+void	(*sighup) __P((int)), (*sigchld) __P((int)), (*sigtstp) __P((int));
@@ -63,0 +78 @@
+#ifdef TIOCSETN
@@ -65,0 +81 @@
+#endif
@@ -71 +87 @@
-#endif KANJI
+#endif /* KANJI */
@@ -114,0 +131,4 @@
+    setvbuf(stdin, NULL, _IONBF, 0);
+    setvbuf(stdout, NULL, _IONBF, 0);
+    setvbuf(stderr, NULL, _IONBF, 0);
+
@@ -175 +195 @@
-		    histlen = atoi (&argv[1] + 2);
+		    histlen = atoi (argv[1] + 2);
@@ -279 +299 @@
-    int sigwinch();
+    void sigwinch __P((int));
@@ -339 +359 @@
-    terminate ();
+    terminate (0);
@@ -387 +407,2 @@
-    int nfound, readfd, writefd = 0, execptfd = 0;
+    int nfound;
+    fd_set readfd, writefd, exceptfd;
@@ -399,3 +420,2 @@
-#   define CHAR_IN_BUFFER (stdin->_cnt)
-    if (CHAR_IN_BUFFER)
-	goto RETURNCHAR;
+    FD_ZERO(&writefd);
+    FD_ZERO(&exceptfd);
@@ -412 +432 @@
-		terminate();
+		terminate(1);
@@ -418 +438 @@
-    if (readfd & mastermask) {
+    if (FD_ISSET(master, &readfd)) {
@@ -454 +474 @@
-    if (CHAR_IN_BUFFER || readfd & stdinmask) {
+    if (FD_ISSET(fileno(stdin), &readfd)) {
@@ -470,2 +490,2 @@
-		printf ("EOF chatched\n");
-	    terminate ();
+		printf ("EOF catched\n");
+	    terminate (1);
@@ -599 +619 @@
-    int readfd = mastermask;
+    fd_set readfd = mastermask;
@@ -607 +627 @@
-	readfd & mastermask
+	FD_ISSET(master, &mastermask)
@@ -639 +659,3 @@
-catchsig()
+void
+catchsig(n)
+    int n;
@@ -641 +663 @@
-    union wait status;
+    int status;
@@ -648 +670 @@
-	    message ("Child has sttoped!!\n");
+	    message ("Child has stopped!!\n");
@@ -653 +675 @@
-    terminate ();
+    terminate (WEXITSTATUS(status));
@@ -677,0 +700,3 @@
+#ifdef TERMIOS
+    tcsetattr(0, TCSANOW, &slave_ttymode);
+#elif defined(TIOCSETN)
@@ -679 +704 @@
-
+#endif
@@ -684,0 +710,21 @@
+#ifdef TERMIOS
+fix_tty()
+{
+    int i;
+    master_ttymode = initial_ttymode;
+    slave_ttymode = initial_ttymode;
+    master_ttymode.c_lflag &= ~(ECHO|ECHOE|ECHOK|ICANON);
+
+    for (i = 0; i < NCCS; i++)
+	master_ttymode.c_cc[i] = _POSIX_VDISABLE;
+
+    master_ttymode.c_cc[VMIN] = 1;
+    master_ttymode.c_cc[VTIME] = 0;
+    slave_ttymode.c_lflag &= ~(ECHO|ECHOE|ECHOK);
+    slave_ttymode.c_iflag &= ~(ICRNL);
+    slave_ttymode.c_oflag &= ~(ONLCR);
+    tcsetattr(0, TCSANOW, &master_ttymode);
+}
+
+#elif defined(TIOCSETN)
+
@@ -721,0 +768 @@
+#endif
@@ -730 +777,3 @@
-terminate()
+void
+terminate(n)
+    int n;
@@ -761,0 +811,3 @@
+#ifdef TERMIOS
+    tcsetattr(0, TCSANOW, &initial_ttymode);
+#elif defined(TIOCSETN)
@@ -765 +817,2 @@
-    exit (0);
+#endif
+    exit (n);
@@ -777,0 +831,35 @@
+#ifdef HAVE_PTMX
+    if ((master = open("/dev/ptmx", O_RDWR)) == -1) {
+	perror ("Couldn't open pseudo tty");
+	kill_process ();
+	exit (1);
+    }
+    if (grantpt (master) == -1) {
+	perror ("grantpt");
+	kill_process ();
+	exit (1);
+    }
+    if (unlockpt (master) == -1) {
+	perror ("grantpt");
+	kill_process ();
+	exit (1);
+    }
+    {
+#ifdef __linux__
+	if (ptsname_r (master, slave_tty, sizeof(slave_tty)) == -1) {
+	    perror ("ptsname_r");
+	    kill_process ();
+	    exit (1);
+	}
+#else
+	char *ptr;
+	if ((ptr = ptsname (master)) == NULL) {
+	    perror ("ptsname");
+	    kill_process ();
+	    exit (1);
+	}
+	(void)strncpy (slave_tty, ptr, sizeof(slave_tty));
+	slave_tty[sizeof(slave_tty) - 1] = '\0';
+#endif
+    }
+#else
@@ -798,0 +887,4 @@
+#endif
+#ifdef TERMIOS
+    tcgetattr(0, &initial_ttymode);
+#elif defined(TIOCSETN)
@@ -803,0 +896 @@
+#endif
@@ -823 +916 @@
-#endif KANJI
+#endif /* KANJI */
@@ -825,3 +918,7 @@
-    stdinmask = 1 << fileno (stdin);
-    mastermask = 1 << master;
-    selectmask = stdinmask | mastermask;
+    FD_ZERO(&stdinmask);
+    FD_ZERO(&mastermask);
+    FD_ZERO(&selectmask);
+    FD_SET(fileno(stdin), &stdinmask);
+    FD_SET(master, &mastermask);
+    FD_SET(fileno(stdin), &selectmask);
+    FD_SET(master, &selectmask);
@@ -840,0 +938,8 @@
+    if (setsid() == -1)
+	perror ("setsid");
+    if (ioctl (slave, TIOCSCTTY, 1) == -1)
+	perror ("ioctl");
+
+#ifdef TERMIOS
+    tcsetattr(slave, TCSANOW, &initial_ttymode);
+#elif defined(TIOCSETN)
@@ -845,0 +951 @@
+#endif
@@ -854 +960 @@
-#endif KANJI
+#endif /* KANJI */
@@ -869 +975,3 @@
-
+#ifdef TERMIOS
+    tcsetattr(0, TCSANOW, &initial_ttymode);
+#elif defined(TIOCSETN)
@@ -872,0 +981 @@
+#endif
@@ -878 +987 @@
-    void	(*func) ();
+    void	(*func) __P((int));
@@ -893 +1002 @@
-	terminate ();
+	terminate (1);
