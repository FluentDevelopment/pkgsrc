$NetBSD: patch-ah,v 1.2 2003/12/13 20:27:42 xtraeme Exp $

--- sysdeps/freebsd/procmap.c.orig	2003-09-07 00:45:14.000000000 +0200
+++ sysdeps/freebsd/procmap.c	2003-09-07 00:51:01.000000000 +0200
@@ -32,9 +32,21 @@
 #include <sys/param.h>
 #include <sys/proc.h>
 #include <sys/resource.h>
+#if defined(__NetBSD__) && (__NetBSD_Version__ < 105020000)
 #include <vm/vm_object.h>
 #include <vm/vm_prot.h>
 #include <vm/vm_map.h>
+#elif defined(__NetBSD__) && (__NetBSD_Version__ >= 105020000)
+#include <uvm/uvm_extern.h>
+#else
+#include <vm/vm_object.h>
+#include <vm/vm_map.h>
+#if (__FreeBSD_version >= 400011)
+#include <vm/vm.h>
+#else
+#include <vm/vm_prot.h>
+#endif
+#endif
 
 #include <sys/vnode.h>
 #include <sys/mount.h>
@@ -46,7 +58,9 @@
 #include <sys/user.h>
 #endif
 #include <sys/sysctl.h>
+#if !defined(__NetBSD__) || (__NetBSD_Version__ < 105020000)
 #include <vm/vm.h>
+#endif
 
 #if defined(__NetBSD__) && (__NetBSD_Version__ >= 104000000)
 /* Fixme ... */
@@ -91,8 +105,9 @@
 	glibtop_map_entry *maps;
 #if defined __FreeBSD__
 	struct vnode vnode;
+#if __FreeBSD_version >= 500039
 	struct inode inode;
-	struct mount mount;
+#endif
 #endif
 	int count, i = 0;
 	int update = 0;
@@ -114,7 +129,11 @@
 	/* Now we get the memory maps. */
 
 	if (kvm_read (server->machine.kd,
+#if defined(__FreeBSD__) && (__FreeBSD_version >= 500013)
+			(unsigned long) pinfo [0].ki_vmspace,
+#else
 		      (unsigned long) pinfo [0].kp_proc.p_vmspace,
+#endif 
 		      (char *) &vmspace, sizeof (vmspace)) != sizeof (vmspace))
 		glibtop_error_io_r (server, "kvm_read (vmspace)");
 
@@ -214,9 +233,10 @@
 #endif
 
 #if defined(__NetBSD__) && (__NetBSD_Version__ >= 104000000)
+#if defined(UVM_VNODE_VALID)
 		if (!vnode.v_uvm.u_flags & UVM_VNODE_VALID)
 			continue;
-
+#endif
 		if ((vnode.v_type != VREG) || (vnode.v_tag != VT_UFS) ||
 		    !vnode.v_data) continue;
 
@@ -244,6 +264,15 @@
 			      &vnode, sizeof (vnode)) != sizeof (vnode))
 			glibtop_error_io_r (server, "kvm_read (vnode)");
 
+#if defined(__FreeBSD__) && (__FreeBSD_version >= 500039)
+               switch (vnode.v_type) {
+                   case VREG:
+                       maps [i-1].inode = vnode.v_cachedid;
+                       maps [i-1].device = vnode.v_cachedfs;
+                   default:
+                   continue;
+               }
+#else
 		if ((vnode.v_type != VREG) || (vnode.v_tag != VT_UFS) ||
 		    !vnode.v_data) continue;
 
@@ -256,7 +285,7 @@
 			      (unsigned long) vnode.v_mount,
 			      &mount, sizeof (mount)) != sizeof (mount))
 			glibtop_error_io_r (server, "kvm_read (mount)");
-
+#endif
 		maps [i-1].inode  = inode.i_number;
 		maps [i-1].device = inode.i_dev;
 #endif
