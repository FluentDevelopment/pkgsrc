$NetBSD: patch-ar,v 1.7 2003/01/16 14:46:08 christos Exp $

--- src/server.c.orig	Thu Jan 16 09:37:28 2003
+++ src/server.c	Thu Jan 16 09:44:24 2003
@@ -772,6 +772,7 @@
        nothing.  But for rsh, we need to do it now.  */
     parse_config (current_parsed_root->directory);
 
+    if (!nolock) {
     path = xmalloc (strlen (current_parsed_root->directory)
 		   + sizeof (CVSROOTADM)
 		   + 2);
@@ -789,6 +790,7 @@
 	pending_error = save_errno;
     }
     free (path);
+    }
 
 #ifdef HAVE_PUTENV
     env = xmalloc (strlen (CVSROOT_ENV) + strlen (current_parsed_root->directory) + 2);
@@ -971,9 +973,6 @@
 	return;
     }
 
-    if (dir_name != NULL)
-	free (dir_name);
-
     dir_len = strlen (dir);
 
     /* Check for a trailing '/'.  This is not ISDIRSEP because \ in the
@@ -989,6 +988,9 @@
 	return;
     }
 
+    if (dir_name != NULL)
+	free (dir_name);
+
     dir_name = xmalloc (strlen (server_temp_dir) + dir_len + 40);
     if (dir_name == NULL)
     {
@@ -2174,6 +2176,8 @@
     {
 	case 'n':
 	    noexec = 1;
+	case 'u':
+	    nolock = 1;
 	    break;
 	case 'q':
 	    quiet = 1;
@@ -4745,8 +4749,13 @@
   REQ_LINE("Max-dotdot", serve_max_dotdot, 0),
   REQ_LINE("Static-directory", serve_static_directory, 0),
   REQ_LINE("Sticky", serve_sticky, 0),
+#ifdef notdef
   REQ_LINE("Checkin-prog", serve_checkin_prog, 0),
   REQ_LINE("Update-prog", serve_update_prog, 0),
+#else
+  REQ_LINE("Checkin-prog", serve_noop, 0),
+  REQ_LINE("Update-prog", serve_noop, 0),
+#endif
   REQ_LINE("Entry", serve_entry, RQ_ESSENTIAL),
   REQ_LINE("Kopt", serve_kopt, 0),
   REQ_LINE("Checkin-time", serve_checkin_time, 0),
@@ -5237,6 +5246,7 @@
     const char *username;
 {
     struct passwd *pw;
+    int rc;
 
     pw = getpwnam (username);
     if (pw == NULL)
@@ -5296,7 +5306,15 @@
 	}
     }
 
-    if (setuid (pw->pw_uid) < 0)
+#ifdef SETXID_SUPPORT
+    /* Honor the setuid bit iff set. */
+    if (getuid() != geteuid())
+        rc = setuid (geteuid ());
+    else 
+#else
+        rc = setuid (pw->pw_uid);
+#endif 
+    if (rc < 0)
     {
 	/* Note that this means that if run as a non-root user,
 	   CVSROOT/passwd must contain the user we are running as
