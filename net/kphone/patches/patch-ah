$NetBSD: patch-ah,v 1.1 2004/07/21 21:49:02 scw Exp $

--- kphone/dspoutoss.cpp.orig	2004-03-29 15:59:45.000000000 +0100
+++ kphone/dspoutoss.cpp	2004-07-21 12:35:56.000000000 +0100
@@ -6,6 +6,9 @@
 #include <fcntl.h>
 #include <unistd.h>
 #include <errno.h>
+#ifdef __NetBSD__
+#include <sys/audioio.h>
+#endif
 
 #include "dspoutoss.h"
 
@@ -52,6 +55,7 @@
 	flags &= ~O_NONBLOCK;
 	fcntl( audio_fd, F_SETFL, flags );
 
+#ifndef __NetBSD__
 	// keep fragsize less than 20ms !!
 	int frag = ( ( 32767 << 16 ) | 7 );
 	if( ioctl( audio_fd, SNDCTL_DSP_SETFRAGMENT, &frag ) ) {
@@ -59,6 +63,7 @@
 		printf( "ERROR: %s\n", lasterror.ascii() );
 		return false;
 	}
+#endif
 
 	int format = AFMT_S16_LE;
 
@@ -108,6 +113,23 @@
 			8000, rate, 100*((rate-8000)/8000.0) );
 	}
 
+#ifdef __NetBSD__
+	int duplex = 1;
+
+	if( ioctl( audio_fd, AUDIO_SETFD, &duplex ) == -1 ) {
+		lasterror = QString( "SETFD" ) + QString( strerror( errno ) );
+		printf( "ERROR: %s\n", lasterror.ascii() );
+		return false;
+	}
+
+	// keep fragsize less than 20ms !!
+	int frag = ( ( 32767 << 16 ) | 7 );
+	if( ioctl( audio_fd, SNDCTL_DSP_SETFRAGMENT, &frag ) ) {
+		lasterror = QString( "SETFRAG" ) + QString( strerror( errno ) );
+		printf( "ERROR: %s\n", lasterror.ascii() );
+		return false;
+	}
+#endif
 
 	audio_buf_info info;
 
@@ -126,6 +148,14 @@
 	}
 	audio_buf.resize( info.fragsize * sizeof( short ) );
 
+#ifdef __NetBSD__
+	if( ioctl( audio_fd, AUDIO_FLUSH, 0 ) == -1 ) {
+		lasterror = QString( "FLUSH" ) + QString( strerror( errno ) );
+		printf( "ERROR: %s\n", lasterror.ascii() );
+		return false;
+	}
+#endif
+
 	lasterror = QString::null;
 	devstate = DeviceOpened;
 	return true;
@@ -149,6 +179,14 @@
 	}
 	audio_buf.resize( info.fragsize * sizeof( short ) );
 
+#ifdef __NetBSD__
+	if( ioctl( audio_fd, AUDIO_FLUSH, 0 ) == -1 ) {
+		lasterror = QString( "FLUSH" ) + QString( strerror( errno ) );
+		printf( "ERROR: %s\n", lasterror.ascii() );
+		return false;
+	}
+#endif
+
 	lasterror = QString::null;
 	devstate = DeviceOpened;
 	return true;
@@ -215,6 +253,7 @@
 
 unsigned int DspOutOss::readableBytes( void )
 {
+#ifndef __NetBSD__
 	audio_buf_info info;
 	struct timeval timeout;
 	fd_set read_fds;
@@ -238,6 +277,18 @@
 	}
 
 	return info.bytes;
+
+#else /* !__NetBSD__ */
+
+	/* XXXSCW: This sucks, but kphone refuses to work without it */
+	int rsize;
+
+	if( ioctl( audio_fd, FIONREAD, &rsize) < 0 )
+		return 0;
+	if (rsize == 0)
+		rsize = 256;
+	return rsize;
+#endif /* __NetBSD__ */
 }
 
 
