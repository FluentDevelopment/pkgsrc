$NetBSD: patch-bd,v 1.2 2003/02/22 23:37:15 mjl Exp $

--- Makefile.in.orig	2003-02-19 09:53:03.000000000 +0100
+++ Makefile.in	2003-02-19 09:52:48.000000000 +0100
@@ -5,6 +5,7 @@
 bindir=@bindir@
 sbindir=@sbindir@
 libdir=@libdir@
+includedir=@includedir@
 mandir=@mandir@
 mansubdir=@mansubdir@
 sysconfdir=@sysconfdir@
@@ -25,7 +26,7 @@
 #Rules: major  -- inc for incompatible change
 #     : minor  -- inc for bugfix or forward compatible change
 
-LIBVERSION=1.0
+LIBVERSION=1
 
 PATHS= 
 
@@ -33,7 +34,7 @@
 LD=@LD@
 CFLAGS=@CFLAGS@
 CPPFLAGS=-I. -I$(srcdir) @CPPFLAGS@ $(PATHS) @DEFS@
-LDFLAGS=@LDFLAGS@
+LDFLAGS=@LDFLAGS@ -L.
 LIBS=@LIBS@
 THLDFLAGS=@THLDFLAGS@
 THLIBS=@THLIBS@
@@ -51,8 +52,10 @@
 PERL=@PERL@
 ENT=@ENT@
 EXEEXT=@EXEEXT@
+SHLDSONAME=-Wl,-soname,libspread.so.$(LIBVERSION)
+TSHLDSONAME=-Wl,-soname,libtspread.so.$(LIBVERSION)
 
-TARGETS=spread$(EXEEXT) spuser$(EXEEXT) spflooder$(EXEEXT) spmonitor$(EXEEXT) sptuser${EXEEXT} @LIBSPSO@ @LIBTSPSO@
+TARGETS=spread$(EXEEXT) spuser$(EXEEXT) spflooder$(EXEEXT) spmonitor$(EXEEXT) sptuser${EXEEXT} @LIBSPSO@ @LIBTSPSO@ libspread.a libtspread.a
 
 LIBSP_OBJS= alarm.o events.o memory.o sp.o
 
@@ -123,8 +126,11 @@
 	$(INSTALL) -m 0755 libspread.$(LIBVERSION).dylib $(DESTDIR)$(libdir)/libspread.$(LIBVERSION).dylib
 	(cd $(DESTDIR)$(libdir); $(SOFTLINK) libspread.$(LIBVERSION).dylib libspread.dylib)
 
-libspread.so:	$(LIBSP_SHOBJS)
-	$(SHLD) -o $@ $(LIBSP_SHOBJS) $(SHLDFLAGS) $(SHLIBS)
+libspread.so:	$@.$(LIBVERSION)
+	$(SOFTLINK) $@.$(LIBVERSION) $@
+
+libspread.so.$(LIBVERSION):	$(LIBSP_SHOBJS)
+	$(SHLD) -o $@ $(LIBSP_SHOBJS) $(SHLDSONAME) $(SHLDFLAGS) $(SHLIBS)
 
 install-libspread.so:	libspread.so
 	$(INSTALL) -m 0755 libspread.so $(DESTDIR)$(libdir)/libspread.so.$(LIBVERSION)
@@ -142,8 +148,11 @@
 	$(INSTALL) -m 0755 libtspread.$(LIBVERSION).dylib $(DESTDIR)$(libdir)/libtspread.$(LIBVERSION).dylib
 	(cd $(DESTDIR)$(libdir); $(SOFTLINK) libtspread.$(LIBVERSION).dylib libtspread.dylib)
 
-libtspread.so:	$(LIBTSP_SHOBJS)
-	$(SHLD) -o $@ $(LIBTSP_SHOBJS) $(SHLDFLAGS) $(SHLIBS) $(THLIBS)
+libtspread.so:	$@.$(LIBVERSION)
+	$(SOFTLINK) $@.$(LIBVERSION) $@
+
+libtspread.so.$(LIBVERSION):	$(LIBTSP_SHOBJS)
+	$(SHLD) -o $@ $(LIBTSP_SHOBJS) $(TSHLDSONAME) $(SHLDFLAGS) $(SHLIBS) $(THLIBS)
 
 install-libtspread.so:	libtspread.so
 	$(INSTALL) -m 0755 libtspread.so $(DESTDIR)$(libdir)/libtspread.so.$(LIBVERSION)
@@ -152,17 +161,17 @@
 spread$(EXEEXT): $(SPREADOBJS)
 	$(LD) -o $@ $(SPREADOBJS) $(LDFLAGS) $(LIBS)
 
-spuser$(EXEEXT): libspread.a	user.o
-	$(LD) -o $@ user.o $(LDFLAGS) libspread.a $(LIBS)
+spuser$(EXEEXT): libspread.so	user.o
+	$(LD) -o $@ user.o $(LDFLAGS) -lspread $(LIBS)
 
-spflooder$(EXEEXT): libspread.a flooder.o
-	$(LD) -o $@ flooder.o $(LDFLAGS) libspread.a $(LIBS)
+spflooder$(EXEEXT): libspread.so flooder.o
+	$(LD) -o $@ flooder.o $(LDFLAGS) -lspread $(LIBS)
 
 spmonitor$(EXEEXT): $(MONITOROBJS)
 	$(LD) -o $@ $(MONITOROBJS) $(LDFLAGS) $(LIBS) 
 
-sptuser$(EXEEXT): user.to libtspread.a
-	$(LD) $(THLDFLAGS) -o $@ user.to libtspread.a $(LDFLAGS) $(LIBS) $(THLIBS)
+sptuser$(EXEEXT): user.to libtspread.so
+	$(LD) $(THLDFLAGS) -o $@ user.to -ltspread $(LDFLAGS) $(LIBS) $(THLIBS)
 
 spsimple_user$(EXEEXT): simple_user.o libspread.a
 	$(LD) -o $@ simple_user.o $(LDFLAGS) libspread.a $(LIBS) 
@@ -211,6 +220,7 @@
 install-files:
 	$(buildtoolsdir)/mkinstalldirs $(DESTDIR)$(bindir)
 	$(buildtoolsdir)/mkinstalldirs $(DESTDIR)$(sbindir)
+	$(buildtoolsdir)/mkinstalldirs $(DESTDIR)$(includedir)
 	$(buildtoolsdir)/mkinstalldirs $(DESTDIR)$(mandir)
 	$(buildtoolsdir)/mkinstalldirs $(DESTDIR)$(mandir)/$(mansubdir)1
 	$(buildtoolsdir)/mkinstalldirs $(DESTDIR)$(mandir)/$(mansubdir)3
@@ -222,6 +232,9 @@
 	$(INSTALL) -m 0755 -s spread$(EXEEXT) $(DESTDIR)$(sbindir)/spread$(EXEEXT)
 	$(INSTALL) -m 644 libspread.a $(DESTDIR)$(libdir)/libspread.a
 	$(INSTALL) -m 644 libtspread.a $(DESTDIR)$(libdir)/libtspread.a
+	$(INSTALL) -m 644 sp.h $(DESTDIR)$(includedir)/spread/sp.h
+	$(INSTALL) -m 644 sp_func.h $(DESTDIR)$(includedir)/spread/sp_func.h
+	$(INSTALL) -m 644 sp_events.h $(DESTDIR)$(includedir)/spread/sp_events.h
 	$(INSTALL) -m 644 docs/spread.1.out $(DESTDIR)$(mandir)/$(mansubdir)1/spread.1
 	$(INSTALL) -m 644 docs/spuser.1.out $(DESTDIR)$(mandir)/$(mansubdir)1/spuser.1
 	$(INSTALL) -m 644 docs/sptuser.1.out $(DESTDIR)$(mandir)/$(mansubdir)1/sptuser.1
@@ -235,11 +248,11 @@
 	if [ ! -d $(DESTDIR)$(sysconfdir) ]; then \
 		$(buildtoolsdir)/mkinstalldirs $(DESTDIR)$(sysconfdir); \
 	fi
-	if [ ! -f $(DESTDIR)$(sysconfdir)/spread.conf ]; then \
-		$(INSTALL) -m 644 $(srcdir)/sample.spread.conf $(DESTDIR)$(sysconfdir)/spread.conf; \
-	else \
-		echo "$(DESTDIR)$(sysconfdir)/spread.conf already exists, install will not overwrite"; \
-	fi
+#	if [ ! -f $(DESTDIR)$(sysconfdir)/spread.conf ]; then \
+#		$(INSTALL) -m 644 $(srcdir)/sample.spread.conf $(DESTDIR)$(sysconfdir)/spread.conf; \
+#	else \
+#		echo "$(DESTDIR)$(sysconfdir)/spread.conf already exists, install will not overwrite"; \
+#	fi
 
 uninstallall:	uninstall
 	-rm -f $(DESTDIR)$(sysconfdir)/spread.conf
