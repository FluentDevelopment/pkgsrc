$NetBSD: patch-ag,v 1.5 2005/11/14 08:05:27 jlam Exp $

--- passdb/passdb.c.orig	2005-10-12 13:03:35.000000000 -0400
+++ passdb/passdb.c
@@ -246,6 +246,7 @@ static NTSTATUS pdb_set_sam_sids(SAM_ACC
 NTSTATUS pdb_fill_sam_pw(SAM_ACCOUNT *sam_account, const struct passwd *pwd)
 {
 	NTSTATUS ret;
+	char *gecos;
 
 	if (!pwd) {
 		return NT_STATUS_UNSUCCESSFUL;
@@ -254,7 +255,9 @@ NTSTATUS pdb_fill_sam_pw(SAM_ACCOUNT *sa
 	pdb_fill_default_sam(sam_account);
 
 	pdb_set_username(sam_account, pwd->pw_name, PDB_SET);
-	pdb_set_fullname(sam_account, pwd->pw_gecos, PDB_SET);
+	gecos = passwd_expand_gecos(pwd);
+	pdb_set_fullname(sam_account, gecos, PDB_SET);
+	SAFE_FREE(gecos);
 
 	pdb_set_unix_homedir(sam_account, pwd->pw_dir, PDB_SET);
 
