$NetBSD: patch-bc,v 1.3 2004/07/23 16:45:43 taca Exp $

--- smbd/filename.c.orig	2003-05-20 11:17:18.000000000 +0900
+++ smbd/filename.c
@@ -314,7 +314,7 @@ BOOL unix_convert(char *name,connection_
 				 */
 
 				if (mangle_is_mangled(start)) {
-					mangle_check_cache( start );
+					mangle_check_cache( start, sizeof(pstring) - 1 - (start - name) );
 				}
 
 				DEBUG(5,("New file %s\n",start));
@@ -472,7 +472,7 @@ static BOOL scan_directory(const char *p
 	 * (JRA).
 	 */
 	if (mangled)
-		mangled = !mangle_check_cache( name );
+		mangled = !mangle_check_cache( name, maxlength );
 
 	/* open the directory */
 	if (!(cur_dir = OpenDir(conn, path, True))) {
