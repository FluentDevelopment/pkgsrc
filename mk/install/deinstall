# start of deinstall
#
# $NetBSD: deinstall,v 1.31 2005/01/28 07:37:55 jlam Exp $

eval set -- ${CONF_FILES} ${SUPPORT_FILES}
while [ $# -gt 0 ]; do
	samplefile="$1"; file="$2"
	shift; shift
	ALL_FILES="${ALL_FILES} \"${samplefile}\" \"${file}\""
	VIEW_FILES="${VIEW_FILES} \"${file}\""
done
if [ "${_PKG_RCD_SCRIPTS}" = "YES" ]; then
	eval set -- ${RCD_SCRIPTS}
	for script; do
		samplefile="${PKG_PREFIX}/${RCD_SCRIPTS_EXAMPLEDIR}/${script}"
		file="${RCD_SCRIPTS_DIR}/${script}"
		shift
		ALL_FILES="${ALL_FILES} \"${samplefile}\" \"${file}\""
	done
fi
eval set -- ${CONF_FILES_PERMS} ${SUPPORT_FILES_PERMS}
while [ $# -gt 0 ]; do
	samplefile="$1"; file="$2"; owner="$3"; group="$4"; mode="$5"
	shift; shift; shift; shift; shift
	ALL_FILES="${ALL_FILES} \"${samplefile}\" \"${file}\""
	VIEW_FILES="${VIEW_FILES} \"${file}\""
done

case ${STAGE} in
VIEW-DEINSTALL)
	if [ "${_PKG_CONFIG}" = "YES" -a -n "${VIEW_FILES}" ]; then
		if [ -n "${PKG_SYSCONFDEPOTBASE}" ]; then
			${SETENV} PLIST_IGNORE_FILES="${CONF_IGNORE_FILES}" \
				${LINKFARM} -D -t ${PKG_SYSCONFVIEWBASE} -d ${PKG_SYSCONFDEPOTBASE} ${PKGNAME}
			${RMDIR} -p ${PKG_SYSCONFVIEWBASE} 2>/dev/null || ${TRUE}
		else
			eval set -- ${VIEW_FILES}
			for file; do
				link=`${ECHO} ${file} | ${SED} "s,^${PREFIX}/,${PKG_PREFIX}/,"`
				dir=`${DIRNAME} ${link}`
				if [ -h "${link}" ]; then
					${RM} -f ${link}
					${RMDIR} -p ${dir} 2>/dev/null || ${TRUE}
				fi
			done
		fi
	fi
	if [ -n "${PKG_SHELL}" -a "${PKG_REGISTER_SHELLS}" = "YES" ]; then
		${ECHO} "===> Updating /etc/shells"
		${CP} /etc/shells /etc/shells.pkgsrc."$$"
		(${GREP} -v "^${PKG_SHELL}" /etc/shells.pkgsrc."$$" || ${TRUE}) > /etc/shells
		${RM} /etc/shells.pkgsrc."$$"
	fi
	;;

DEINSTALL)
	# Remove configuration files if they don't differ from the default
	# config file.
	#
        if [ "${_PKG_CONFIG}" = "YES" ]; then
		eval set -- ${ALL_FILES}
		while [ $# -gt 0 ]; do
			samplefile="$1"; file="$2"
			shift; shift

			if [ ! "${file}" -ef "${samplefile}" -a		\
			     -f "${file}" -a -f "${samplefile}" ]; then
				if ${CMP} -s "${file}" "${samplefile}"; then
					${RM} -f "${file}"
				fi
			fi
		done
	fi
	;;

POST-DEINSTALL)
	modified_files=''
	eval set -- ${ALL_FILES}
	while [ $# -gt 0 ]; do
		samplefile="$1"; file="$2"
		shift; shift

		if [ -f "${file}" ]; then
			modified_files="${modified_files} \"${file}\""
		fi
	done

	if [ "${PKG_INSTALLATION_TYPE}" = "pkgviews" -a			\
	     "${_PKG_CONFIG}" = "YES" -a -n "${CONF_DEPENDS}" ]; then
		if [ -h ${PKG_SYSCONFDIR} ]; then
			${RM} -f ${PKG_SYSCONFDIR}
		fi
		${RMDIR} -p `${DIRNAME} ${PKG_SYSCONFDIR}` 2>/dev/null || ${TRUE}
	fi

	case ${_PKG_CONFIG} in
	YES)	${TEST} -x ./+DIRS && ./+DIRS REMOVE ${PKG_METADATA_DIR} ;;
	esac
	case ${_PKG_CREATE_USERGROUP} in
	YES)	${TEST} -x ./+USERGROUP && ./+USERGROUP REMOVE ${PKG_METADATA_DIR} ;;
	esac

	if [ -n "${modified_files}" ]; then
		${CAT} << EOF
===========================================================================
If you won't be using ${PKGNAME} any longer, you may want to remove
EOF
		if [ -n "${modified_files}" ]; then
			${CAT} << EOF

  * the following files:

EOF
			eval set -- ${modified_files}
			for file; do
				${ECHO} "	${file}"
			done
		fi
		if [ -n "${RCD_SCRIPTS}" ]; then
			${CAT} << EOF

You may also want to remove any settings in rc.conf that you may have
made in order to use ${PKGNAME}.
EOF
		fi
		${CAT} << EOF
===========================================================================
EOF
	fi

	${TEST} -x ./+USERGROUP && ./+USERGROUP CHECK-REMOVE ${PKG_METADATA_DIR}
	${TEST} -x ./+DIRS && ./+DIRS CHECK-REMOVE ${PKG_METADATA_DIR}
	;;
esac

# end of deinstall
