$NetBSD: patch-an,v 1.3 2007/04/27 19:45:02 christos Exp $

--- net.c.orig	2005-07-04 19:33:38.000000000 -0400
+++ net.c	2007-04-27 14:58:48.000000000 -0400
@@ -35,6 +35,9 @@
 #include <sys/stat.h>
 #include <sys/socket.h>
 #include <sys/un.h>
+#ifdef NETBSD
+#define ucred uucred
+#endif
 
 #if defined(HAVE_SIN6_SCOPE_ID_LINUX)
 #define in6_addr in6_addr_libc
@@ -43,12 +46,16 @@
 #endif
 
 #include <netinet/in.h>
-#ifdef HAVE_NETINET_TCP_H
+#if defined(HAVE_NETINET_TCP_H) || defined(NETBSD)
 #include <netinet/tcp.h>
 #endif
-#ifdef HAVE_NETINET_UDP_H
+#if defined(HAVE_NETINET_UDP_H) || defined(NETBSD)
 #include <netinet/udp.h>
 #endif
+#ifdef NETBSD
+#include <sys/param.h>
+#include <sys/ucred.h>
+#endif
 #include <arpa/inet.h>
 #include <net/if.h>
 #if defined(LINUX)
@@ -1099,7 +1106,7 @@
 		return;
 	}
 
-	tprintf(", {cmsg_len=%zu, cmsg_level=", cmsg->cmsg_len);
+	tprintf(", {cmsg_len=%zu, cmsg_level=", (size_t)cmsg->cmsg_len);
 	printxval(socketlayers, cmsg->cmsg_level, "SOL_???");
 	tprintf(", cmsg_type=");
 
@@ -1125,12 +1132,21 @@
 			free(cmsg);
 			return;
 		}
+#if !defined(SCM_CREDENTIALS) && defined(SCM_CREDS)
+#define SCM_CREDENTIALS SCM_CREDS
+#endif
+
 		if (cmsg->cmsg_type == SCM_CREDENTIALS
 		    && CMSG_LEN(sizeof(struct ucred)) <= cmsg_len) {
 			struct ucred *uc = (struct ucred *) CMSG_DATA (cmsg);
 
+#ifdef NETBSD
+			tprintf("{uid=%ld, gid=%ld}}",
+				(long)uc->cr_uid, (long)uc->cr_gid);
+#else
 			tprintf("{pid=%ld, uid=%ld, gid=%ld}}",
 				(long)uc->pid, (long)uc->uid, (long)uc->gid);
+#endif
 			free(cmsg);
 			return;
 		}
@@ -1470,7 +1486,7 @@
 		else
 			tprintf("[%u, %u]", fds[0], fds[1]);
 	}
-#elif defined(SPARC) || defined(SPARC64) || defined(SH) || defined(SVR4) || defined(FREEBSD) || defined(IA64)
+#elif defined(SPARC) || defined(SPARC64) || defined(SH) || defined(SVR4) || defined(ALLBSD) || defined(IA64)
 	if (exiting(tcp))
 		tprintf("[%lu, %lu]", tcp->u_rval, getrval2(tcp));
 #endif
@@ -1517,9 +1533,9 @@
 		else
 			tprintf(", [%u, %u]", fds[0], fds[1]);
 #endif /* LINUX */
-#if defined(SUNOS4) || defined(SVR4) || defined(FREEBSD)
+#if defined(SUNOS4) || defined(SVR4) || defined(ALLBSD)
 		tprintf(", [%lu, %lu]", tcp->u_rval, getrval2(tcp));
-#endif /* SUNOS4 || SVR4 || FREEBSD */
+#endif /* SUNOS4 || SVR4 || ALLBSD */
 	}
 	return 0;
 }
