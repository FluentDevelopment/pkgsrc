$NetBSD: patch-ac,v 1.16 2004/04/29 04:19:22 atatat Exp $

Make lsof use statvfs on NetBSD where available.

--- dialects/n+obsd/dmnt.c.orig	2002-06-16 21:44:17.000000000 -0400
+++ dialects/n+obsd/dmnt.c
@@ -56,7 +56,6 @@ readmnt()
 {
 	char *dn = (char *)NULL;
 	char *ln;
-	struct statfs *mb = (struct statfs *)NULL;
 	struct mounts *mtp;
 	int n;
 	struct stat sb;
@@ -65,6 +64,12 @@ readmnt()
 	unsigned char procfs = 0;
 #endif	/* defined(HASPROCFS) */
 
+#if	defined(HASSTATVFS)
+	struct statvfs *mb = (struct statvfs *)NULL;
+#else	/* !defined(HASSTATVFS) */
+	struct statfs *mb = (struct statfs *)NULL;
+#endif	/* defined(HASSTATVFS) */
+
 	if (Lmi || Lmist)
 	    return(Lmi);
 /*
@@ -123,7 +128,13 @@ no_space_for_mount:
 			"      Output information may be incomplete.\n");
 		}
 		(void) bzero((char *)&sb, sizeof(sb));
+
+#if	defined(HASSTATVFS)
+		sb.st_dev = (dev_t)mb->f_fsid;
+#else	/* !defined(HASSTATVFS) */
 		sb.st_dev = (dev_t)mb->f_fsid.val[0];
+#endif	/* defined(HASSTATVFS) */
+
 		sb.st_mode = S_IFDIR | 0777;
 		if (!Fwarn) {
 		    (void) fprintf(stderr,
@@ -222,7 +233,13 @@ readvfs(vm)
 	    Exit(1);
 	}
 	vp->addr = vm;
+
+#if	defined(HASSTATVFS)
+	vp->fsid = m.m_stat.f_fsidx;
+#else	/* !defined(HASSTATVFS) */
 	vp->fsid = m.m_stat.f_fsid;
+#endif	/* defined(HASSTATVFS) */
+
 	(void) snpf(vp->type, sizeof(vp->type), "%s", m.m_stat.f_fstypename);
 	vp->next = Lvfs;
 	Lvfs = vp;
