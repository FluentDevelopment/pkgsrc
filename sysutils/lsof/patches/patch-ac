$NetBSD: patch-ac,v 1.11 2003/09/26 03:13:04 atatat Exp $

Patch for vnode/DNLC interface change courtesy of lsof maintainer.

--- dialects/n+obsd/dnode.c.orig	2003-06-11 07:45:16.000000000 -0400
+++ dialects/n+obsd/dnode.c
@@ -68,8 +68,14 @@
 		if (!p->P_VMSPACE
 		||  kread((KA_T)p->P_VMSPACE, (char *)&vm, sizeof(vm)))
 		    return;
+# if	defined(OPENBSDV)
+		Lf->sz = (SZOFFTYPE)((vm.vm_tsize + vm.vm_dsize
+		       + vm.vm_ssize) * sysconf(_SC_PAGESIZE));
+# else	/* !defined(OPENBSDV */
 		Lf->sz = (SZOFFTYPE)ctob(vm.vm_tsize + vm.vm_dsize
 						     + vm.vm_ssize);
+# endif	/* defined(OPENBSDV) */
+
 		Lf->sz_def = 1;
 		return;
 	    }
@@ -301,9 +307,9 @@
 
 #if	defined(HASNCACHE)
 	Lf->na = va;
-# if	defined(HASNCAPID)
+# if	defined(HASNCVPID)
 	Lf->id = v->v_id;
-# endif	/* defined(HASNCAPID) */
+# endif	/* defined(HASNCVPID) */
 #endif	/* defined(HASNCACHE) */
 
 #if	defined(HASFSTRUCT)
@@ -394,6 +400,9 @@
 		    enter_nm(Namech);
 		    return;
 		} else
+#if defined(NETBSDV) && defined(KERNFSTOV)
+#define kf_kt kfs_kt
+#endif
 		    kn.kf_kt = (struct kern_target *)NULL;
 	    }
 	/*
@@ -402,6 +411,9 @@
 	 */
 	    if (kn.kf_kt
 	    &&  kread((KA_T)kn.kf_kt, (char *)&kt, sizeof(kt)) == 0
+#if defined(NETBSDV) && defined(KERNFSTOV)
+#undef kf_kt kfs_kt
+#endif
 	    &&  (ktnl = (int)kt.kt_namlen) > 0
 	    &&  kt.kt_name)
 	    {
