$NetBSD: patch-ae,v 1.3 2006/01/26 21:43:51 adam Exp $

--- libntfs/device.c.orig	2005-09-28 15:46:04.000000000 +0200
+++ libntfs/device.c
@@ -55,6 +55,8 @@
 #	include <linux/hdreg.h>
 #endif
 
+#include "compat.h"
+
 #include "types.h"
 #include "mst.h"
 #include "debug.h"
@@ -70,6 +72,10 @@
 #define HDIO_GETGEO	0x0301	/* Get device geometry. */
 #endif
 
+#if defined(__NetBSD__)
+#include <sys/disklabel.h> /* XXX autoconf this ? */
+#endif
+
 /**
  * ntfs_device_alloc - allocate an ntfs device structure and pre-initialize it
  * name:	name of the device (must be present)
@@ -519,6 +525,23 @@ s64 ntfs_device_size_get(struct ntfs_dev
 		}
 	}
 #endif
+#ifdef DIOCGPART
+	{
+		struct stat st;
+		if (dev->d_ops->stat(dev, &st) >= 0) {
+			struct disklabel disklabel;
+			int secsize;
+			s64 psize;
+			if (dev->d_ops->ioctl(dev, DIOCGDINFO, &disklabel) >= 0) {
+				secsize = disklabel.d_secsize;
+				psize = disklabel.d_partitions[DISKPART(st.st_rdev)].p_size;
+				Dprintf("DIOCGPART nr %d byte blocks = %lld (0x%llx)\n",
+						secsize, psize, psize);
+				return psize * secsize / block_size;
+			}
+		}
+	}
+#endif
 	/*
 	 * We couldn't figure it out by using a specialized ioctl,
 	 * so do binary search to find the size of the device.
