$NetBSD: patch-ad,v 1.2 2006/01/26 21:43:51 adam Exp $

--- libntfs/debug.c.orig	2004-09-09 09:54:06.000000000 +0200
+++ libntfs/debug.c
@@ -25,18 +25,20 @@
 #include "attrib.h"
 #include "debug.h"
 
+FILE *ntfs_err_out = stderr;
+
 /**
- * Sprintf - silencable output to stderr
- * @silent:	if 0 string is output to stderr
+ * Sprintf - silencable output to ntfs_err_out
+ * @silent:	if 0 string is output to ntfs_err_out
  * @fmt:	printf style format string
  * @...:	optional arguments for the printf style format string
  *
- * If @silent is 0, output the string @fmt to stderr.
+ * If @silent is 0, output the string @fmt to ntfs_err_out.
  *
  * This is basically a replacement for:
  *
  *	if (!silent)
- *		fprintf(stderr, fmt, ...);
+ *		fprintf(ntfs_err_out, fmt, ...);
  *
  * It is more convenient to use Sprintf instead of the above code and perhaps
  * more importantly, Sprintf makes it much easier to turn it into a "do
@@ -48,18 +50,22 @@ void __Sprintf(const int silent, const c
 	int eo;
 	va_list ap;
 
-	if (silent)
+	if (silent || !ntfs_err_out)
 		return;
 	eo = errno;
 	va_start(ap, fmt);
-	vfprintf(stderr, fmt, ap);
+	vfprintf(ntfs_err_out, fmt, ap);
 	va_end(ap);
+	fflush(ntfs_err_out);
 	errno = eo;
 }
 
 #ifdef DEBUG
 
-/* Debug output to stderr.  To get it run ./configure --enable-debug. */
+#ifdef HAVE_STRING_H
+#include <string.h>
+#endif
+/* Debug output to ntfs_err_out.  To get it run ./configure --enable-debug. */
 
 void __ntfs_error(const char *function, const char *fmt, ...)
 {
@@ -68,13 +74,16 @@ void __ntfs_error(const char *function, 
 	va_list args;
 	char err_buf[1024];
 
+	if (!ntfs_err_out)
+		return;
 	if (function)
 		flen = strlen(function);
 	va_start(args, fmt);
-	vsnprintf(err_buf, sizeof(err_buf), fmt, args);
+	vsnprintf(ntfs_err_out, sizeof(err_buf), fmt, args);
 	va_end(args);
-	fprintf(stderr, "NTFS error: %s(): %s\n", flen ? function : "",
+	fprintf(ntfs_err_out, "NTFS error: %s(): %s\n", flen ? function : "",
 			err_buf);
+	fflush(ntfs_err_out);
 	errno = eo;
 }
 
@@ -86,13 +95,16 @@ void __ntfs_debug (const char *file, int
 	va_list args;
 	char err_buf[1024];
 
+	if (!ntfs_err_out)
+		return;
 	if (function)
 		flen = strlen(function);
 	va_start(args, fmt);
-	vsnprintf(err_buf, sizeof(err_buf), fmt, args);
+	vsnprintf(ntfs_err_out, sizeof(err_buf), fmt, args);
 	va_end(args);
-	fprintf(stderr, "NTFS DEBUG (%s, %d): %s(): %s\n", file, line,
+	fprintf(ntfs_err_out, "NTFS DEBUG (%s, %d): %s(): %s\n", file, line,
 			flen ? function : "", err_buf);
+	fflush(ntfs_err_out);
 	errno = eo;
 }
 
@@ -101,16 +113,23 @@ void __Dprintf(const char *fmt, ...)
 	int eo = errno;
 	va_list ap;
 
+	if (!ntfs_err_out)
+		return;
 	va_start(ap, fmt);
-	vfprintf(stderr, fmt, ap);
+	vfprintf(ntfs_err_out, fmt, ap);
 	va_end(ap);
+	fflush(ntfs_err_out);
 	errno = eo;
 }
 
 void __Dputs(const char *s)
 {
 	int eo = errno;
-	fprintf(stderr, "%s\n", s);
+
+	if (!ntfs_err_out)
+		return;
+	fprintf(ntfs_err_out, "%s\n", s);
+	fflush(ntfs_err_out);
 	errno = eo;
 }
 
