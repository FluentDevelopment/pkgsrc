$NetBSD: patch-ac,v 1.2 2006/01/26 21:43:51 adam Exp $

--- libntfs/attrib.c.orig	2005-09-30 21:17:02.000000000 +0200
+++ libntfs/attrib.c
@@ -739,7 +739,7 @@ map_rl:
  */
 s64 ntfs_attr_pread(ntfs_attr *na, const s64 pos, s64 count, void *b)
 {
-	s64 br, to_read, ofs, total, total2;
+	s64 br, to_read, ofs, total, total2, origcount;
 	ntfs_volume *vol;
 	runlist_element *rl;
 
@@ -767,6 +767,7 @@ s64 ntfs_attr_pread(ntfs_attr *na, const
 	}
 	if (!count)
 		return 0;
+	origcount = count;
 	/* Truncate reads beyond end of attribute. */
 	if (pos + count > na->data_size) {
 		if (pos >= na->data_size)
@@ -858,7 +859,7 @@ res_err_out:
 			continue;
 		}
 		/* It is a real lcn, read it into @dst. */
-		to_read = min(count, (rl->length << vol->cluster_size_bits) -
+		to_read = min(origcount, (rl->length << vol->cluster_size_bits) -
 				ofs);
 retry:
 		Dprintf("%s(): Reading 0x%llx bytes from vcn 0x%llx, "
@@ -866,6 +867,12 @@ retry:
 				to_read, rl->vcn, rl->lcn, ofs);
 		br = ntfs_pread(vol->dev, (rl->lcn << vol->cluster_size_bits) +
 				ofs, to_read, b);
+		/* Zero any overage that we may have read */
+		if (br > count) {
+			memset(b + count, 0, br - count);
+			total += count;
+			return total + total2;
+		}
 		/* If everything ok, update progress counters and continue. */
 		if (br > 0) {
 			total += br;
