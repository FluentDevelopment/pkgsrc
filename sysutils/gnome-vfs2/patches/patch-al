$NetBSD: patch-al,v 1.4 2003/04/27 14:44:34 jmmv Exp $

--- modules/file-method.c.orig	2003-02-24 13:18:31.000000000 +0100
+++ modules/file-method.c
@@ -806,6 +806,7 @@ do_read_directory (GnomeVFSMethod *metho
 	result = readdir (handle->dir);
 
 	if (result == NULL && errno != 0) {
+		G_UNLOCK (readdir);
 		return gnome_vfs_result_from_errno ();
 	}
 	if (result != NULL) {
@@ -1113,9 +1114,23 @@ find_trash_in_one_hierarchy_level (const
 
 	item_buffer = g_malloc (sizeof (struct dirent) + GET_PATH_MAX() + 1);
 	for (;;) {
+#ifdef HAVE_READDIR_R	
 		if (readdir_r (directory, item_buffer, &item) != 0 || item == NULL) {
 			break;
 		}
+#else
+		G_LOCK (readdir);
+		errno = 0;
+		item = readdir (directory);
+		if (item == NULL || errno != 0) {
+			G_UNLOCK (readdir);
+			break;
+		}
+		if (item != NULL) {
+			memcpy (item_buffer, item, sizeof (struct dirent));
+		}
+		G_UNLOCK (readdir);
+#endif
 
 		if (gnome_vfs_context_check_cancellation (context))
 			break;
