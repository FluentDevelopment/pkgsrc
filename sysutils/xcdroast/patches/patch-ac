$NetBSD: patch-ac,v 1.7 2002/12/02 20:29:49 drochner Exp $

--- src/io.c.orig	Sun Nov 24 20:02:58 2002
+++ src/io.c	Mon Dec  2 20:21:20 2002
@@ -19,6 +19,14 @@
 #include <sys/wait.h>
 #include <signal.h>
 #include <time.h>
+#ifdef __NetBSD__
+# include <sys/ioctl.h>
+# ifdef HAVE_OSS
+#  include <soundcard.h>
+# else
+#  include <sys/audioio.h>
+# endif
+#endif
 #if defined(linux) || defined(__FreeBSD__)
 # include <sys/soundcard.h>
 # include <sys/ioctl.h>
@@ -1200,22 +1208,22 @@
 struct stat buf;
 #endif
 
-#if defined(sun) || defined(aix) || defined(__OpenBSD__)
+#if defined(sun) || defined(aix) || defined(__OpenBSD__) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 gchar *audiodev;
 #endif
 	dsp = NULL;
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 	/* for linux check if /dev/dsp or /dev/dsp1 exist */
 
-	if (stat("/dev/dsp",&buf) == 0) {
-		dsp = g_list_append(dsp,"/dev/dsp");
+	if (stat("@DEVOSSAUDIO@",&buf) == 0) {
+		dsp = g_list_append(dsp,"@DEVOSSAUDIO@");
 	}
 	if (stat("/dev/dsp1",&buf) == 0) {
 		dsp = g_list_append(dsp,"/dev/dsp1");
 	}
 #endif
-#if defined(sun) || defined(__OpenBSD__)
+#if defined(sun) || defined(__OpenBSD__) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 	/* check if the user has any special audio-hardware running,
 	   which set the AUDIODEV-environment-variable */
 	audiodev = getenv("AUDIODEV");
@@ -1297,15 +1305,15 @@
 struct stat buf;
 # endif
 #endif
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 gchar tmp2[MAXLINE];
 #endif
 
 	strcpy(ret,"");
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 
-	if (strncmp(dsp,"/dev/dsp",8) == 0) {
+	if (strncmp(dsp,"@DEVOSSAUDIO@",8) == 0) {
 		strcpy(tmp,dsp+8);
 		g_snprintf(tmp2,MAXLINE,"/dev/mixer%s",tmp);
 
@@ -1315,7 +1323,7 @@
 		}	
 	}	
 #endif
-#if defined(sun) || defined(__OpenBSD__)
+#if defined(sun) || defined(__OpenBSD__) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 
 	g_snprintf(tmp,MAXLINE,"%s%s",dsp,"ctl");
 
@@ -2795,10 +2803,10 @@
 #if !(defined(__MACH__) && defined(__APPLE__)) 
 gint mix;
 #endif
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 gint val;
 #endif
-#if defined(sun) || defined(__OpenBSD__)
+#if defined(sun) || defined(__OpenBSD__) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 audio_info_t ainfo;
 #endif
 #ifdef hpux
@@ -2813,7 +2821,7 @@
 		return -1;
 	}
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 
 	dodebug(10,"quering mixer %s\n", setupdata.mix_device);
 	mix = open(setupdata.mix_device, O_RDWR);
@@ -2833,7 +2841,7 @@
 	return ((val & 0x7f) + ((val >> 8) & 0x7f))/2;
 
 #endif
-#if defined(sun) || defined(__OpenBSD__)
+#if defined(sun) || defined(__OpenBSD__) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 
 	dodebug(10,"quering mixer %s\n", setupdata.mix_device);
 	mix = open(setupdata.mix_device, O_RDONLY);
@@ -2921,7 +2929,7 @@
 #if !(defined(__MACH__) && defined(__APPLE__)) 
 gint mix;
 #endif
-#if defined(sun) || defined(__OpenBSD__)
+#if defined(sun) || defined(__OpenBSD__) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 audio_info_t ainfo;
 #endif
 #ifdef aix
@@ -2939,7 +2947,7 @@
 		return -1;
 	}
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 
 	dodebug(10,"setting mixer %s to %d\n", setupdata.mix_device, val);
 	mix = open(setupdata.mix_device, O_RDWR);
@@ -2957,7 +2965,7 @@
 	close(mix);
 
 #endif 
-#if defined(sun) || defined(__OpenBSD__)
+#if defined(sun) || defined(__OpenBSD__) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 
 	dodebug(10,"setting mixer %s to %d\n", setupdata.mix_device, val);
 	mix = open(setupdata.mix_device, O_WRONLY);
