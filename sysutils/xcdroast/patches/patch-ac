$NetBSD: patch-ac,v 1.6 2002/10/27 21:46:12 martin Exp $

--- io.c.orig	Tue Jul 17 12:39:11 2001
+++ io.c
@@ -16,6 +16,14 @@
 #include <sys/wait.h>
 #include <signal.h>
 #include <time.h>
+#ifdef __NetBSD__
+# include <sys/ioctl.h>
+# ifdef HAVE_OSS
+#  include <soundcard.h>
+# else
+#  include <sys/audioio.h>
+# endif
+#endif
 #if defined(linux) || defined(__FreeBSD__)
 # include <sys/soundcard.h>
 # include <sys/ioctl.h>
@@ -996,22 +1004,22 @@ GList *get_dsp_devices() {
 GList *dsp;
 GList *loop;
 struct stat buf;
-#ifdef sun
+#if defined(sun) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 gchar *audiodev;
 #endif
 	dsp = NULL;
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 	/* for linux check if /dev/dsp or /dev/dsp1 exist */
 
-	if (stat("/dev/dsp",&buf) == 0) {
-		dsp = g_list_append(dsp,"/dev/dsp");
+	if (stat("@DEVOSSAUDIO@",&buf) == 0) {
+		dsp = g_list_append(dsp,"@DEVOSSAUDIO@");
 	}
 	if (stat("/dev/dsp1",&buf) == 0) {
 		dsp = g_list_append(dsp,"/dev/dsp1");
 	}
 #endif
-#ifdef sun
+#if defined(sun) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 	/* check if the user has any special audio-hardware running,
 	   which set the AUDIODEV-environment-variable */
 	audiodev = getenv("AUDIODEV");
@@ -1066,15 +1074,15 @@ gchar *audiodev;
 gchar *gen_mix_from_dspdev(gchar *dsp, gchar *ret) {
 gchar tmp[MAXLINE];
 struct stat buf;
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 gchar tmp2[MAXLINE];
 #endif
 
 	strcpy(ret,"");
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 
-	if (strncmp(dsp,"/dev/dsp",8) == 0) {
+	if (strncmp(dsp,"@DEVOSSAUDIO@",8) == 0) {
 		strcpy(tmp,dsp+8);
 		g_snprintf(tmp2,MAXLINE,"/dev/mixer%s",tmp);
 
@@ -1084,7 +1092,7 @@ gchar tmp2[MAXLINE];
 		}	
 	}	
 #endif
-#ifdef sun
+#if defined(sun) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 
 	g_snprintf(tmp,MAXLINE,"%s%s",dsp,"ctl");
 
@@ -2362,10 +2370,10 @@ gint count;
 
 gint query_mixer() {
 gint mix;
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 gint val;
 #endif
-#ifdef sun
+#if defined(sun) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 audio_info_t ainfo;
 #endif
 #ifdef hpux
@@ -2380,7 +2388,7 @@ struct audio_gains again;
 		return -1;
 	}
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 
 	dodebug(10,"quering mixer %s\n", setupdata.mix_device);
 	mix = open(setupdata.mix_device, O_RDWR);
@@ -2400,7 +2408,7 @@ struct audio_gains again;
 	return ((val & 0x7f) + ((val >> 8) & 0x7f))/2;
 
 #endif
-#ifdef sun
+#if defined(sun) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 
 	dodebug(10,"quering mixer %s\n", setupdata.mix_device);
 	mix = open(setupdata.mix_device, O_RDONLY);
@@ -2450,7 +2458,7 @@ struct audio_gains again;
 
 gint set_mixer(gint val) {
 gint mix;
-#ifdef sun
+#if defined(sun) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 audio_info_t ainfo;
 #endif
 #ifdef hpux
@@ -2464,7 +2472,7 @@ struct audio_gains again;
 		return -1;
 	}
 
-#if defined(linux) || defined(__FreeBSD__)
+#if defined(linux) || defined(__FreeBSD__) || (defined(__NetBSD__) && defined(HAVE_OSS))
 
 	dodebug(10,"setting mixer %s to %d\n", setupdata.mix_device, val);
 	mix = open(setupdata.mix_device, O_RDWR);
@@ -2482,7 +2490,7 @@ struct audio_gains again;
 	close(mix);
 
 #endif 
-#ifdef sun
+#if defined(sun) || (defined(__NetBSD__) && !defined(HAVE_OSS))
 
 	dodebug(10,"setting mixer %s to %d\n", setupdata.mix_device, val);
 	mix = open(setupdata.mix_device, O_WRONLY);
@@ -3275,6 +3283,9 @@ gint ret,found;
 		/* got the message that no medium is present?
 		   in this case, ignore return code */ 
 		if (strstr(line,"medium not present")) {
+			found = 1;
+		}
+		if (strstr(line,"Device not ready")) {
 			found = 1;
 		}
 	}
