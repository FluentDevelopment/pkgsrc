$NetBSD: patch-ab,v 1.3 2007/08/08 17:12:44 xtraeme Exp $

--- vbetool.c.orig	2006-07-26 03:27:21.000000000 +0200
+++ vbetool.c	2007-08-08 19:07:18.000000000 +0200
@@ -8,19 +8,29 @@
 version 2
 */
 
-#include <pci/pci.h>
 #include <assert.h>
+#include <pciutils/pci.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
 #include <sys/ioctl.h>
 #include <sys/types.h>
+#ifdef __linux__
 #include <sys/io.h>
 #include <sys/kd.h>
+#endif
 #include <sys/stat.h>
 #include <errno.h>
 
+#ifdef __NetBSD__
+#include <machine/sysarch.h>
+#include <machine/pio.h>
+#endif
+
+/* out* arguments are swapped between NetBSD and linux */
+#define __outb(v, p)	outb((p), (v))
+
 #include "include/lrmi.h"
 #include "vbetool.h"
 
@@ -42,8 +52,16 @@
 		exit(1);
 	}
 	
+#ifdef __NetBSD__
+# ifdef __i386__
+	i386_iopl(3);
+# else
+	x86_64_iopl(3);
+# endif
+#else
 	ioperm(0, 1024, 1);
 	iopl(3);
+#endif
 	
 	pacc = pci_alloc();
 	pacc->numeric_ids = 1;
@@ -256,7 +274,9 @@
 
 	LRMI_free_real(data);
 
+#ifdef __linux__
 	ioctl(0, KDSETMODE, KD_TEXT);
+#endif
 
 }
 
@@ -476,23 +496,25 @@
 		return 11;
 	}
 
+#ifdef __linux__
 	ioctl(0, KDSETMODE, KD_GRAPHICS);
+#endif
 	return 0;
 }
 
 int enable_vga() {
-	outb(0x03 | inb(0x3CC),  0x3C2);
-	outb(0x01 | inb(0x3C3),  0x3C3);
-	outb(0x08 | inb(0x46e8), 0x46e8);
-	outb(0x01 | inb(0x102),  0x102);
+	__outb(0x03 | inb(0x3CC),  0x3C2);
+	__outb(0x01 | inb(0x3C3),  0x3C3);
+	__outb(0x08 | inb(0x46e8), 0x46e8);
+	__outb(0x01 | inb(0x102),  0x102);
 	return 0;
 }
 
 int disable_vga() {
-	outb(~0x03 & inb(0x3CC),  0x3C2);
-	outb(~0x01 & inb(0x3C3),  0x3C3);
-	outb(~0x08 & inb(0x46e8), 0x46e8);
-	outb(~0x01 & inb(0x102),  0x102);
+	__outb(~0x03 & inb(0x3CC),  0x3C2);
+	__outb(~0x01 & inb(0x3C3),  0x3C3);
+	__outb(~0x08 & inb(0x46e8), 0x46e8);
+	__outb(~0x01 & inb(0x102),  0x102);
 	return 0;
 }
 
