$NetBSD: patch-aa,v 1.3 2007/05/04 10:13:12 hira Exp $

--- panel-plugin/battery.c.orig	2007-01-18 02:56:51.000000000 +0900
+++ panel-plugin/battery.c	2007-05-01 01:32:49.000000000 +0900
@@ -35,6 +35,7 @@
 #include <sys/ioctl.h>
 #include <machine/apmvar.h>
 #define APMDEVICE "/dev/apm"
+#define _ACPI_APM_BATT_UNKNOWN 0xffff /* from sys/dev/acpi/acpi_apm.c */
 #elif __linux__
 #include <libapm.h>
 #endif
@@ -209,7 +210,7 @@
       battmon->method = BM_BROKEN;
       fd = open(APMDEVICE, O_RDONLY);
       if (fd == -1) return FALSE;
-      +      if (ioctl(fd, APM_IOC_GETPOWER, &apm) == -1) {
+      if (ioctl(fd, APM_IOC_GETPOWER, &apm) == -1) {
         close(fd);
              return FALSE;
     }
@@ -302,13 +303,16 @@
       battmon->method = BM_BROKEN;
       fd = open(APMDEVICE, O_RDONLY);
       if (fd == -1) return TRUE;
-      if (ioctl(fd, APM_IOC_GETPOWER, &apminfo) == -1)
+      if (ioctl(fd, APM_IOC_GETPOWER, &apm) == -1)
             return TRUE;
       close(fd);
       charge = apm.battery_life;
       time_remaining = apm.minutes_left;
       acline = apm.ac_state ? TRUE : FALSE;
 
+      if(battmon->timeoutid != 0) g_source_remove(battmon->timeoutid);
+      battmon->timeoutid = g_timeout_add(2 * 1024,
+              (GSourceFunc) update_apm_status, battmon);
 #else
     struct apm_info apm;
     DBG ("Updating battery status...");
@@ -460,6 +464,11 @@
 
     if(battmon->options.display_percentage && !(battmon->options.hide_when_full && acline && charge >= 99)){
         gtk_widget_show((GtkWidget *)battmon->charge);
+#if defined(__NetBSD__) || defined(__OpenBSD__)
+	 if (apm.battery_state == APM_BATT_ABSENT)
+            g_snprintf(buffer, sizeof(buffer),"--%% ");
+	 else
+#endif
         g_snprintf(buffer, sizeof(buffer),"%d%% ", charge);
         gtk_label_set_text(battmon->charge,buffer);
     } else {
@@ -477,6 +486,11 @@
         }
 
         gtk_widget_show((GtkWidget *)active_label);
+#if defined(__NetBSD__)
+	 if (acline || time_remaining == _ACPI_APM_BATT_UNKNOWN)
+            g_snprintf(buffer, sizeof(buffer), "--:--");
+	 else
+#endif
         g_snprintf(buffer, sizeof(buffer),"%02d:%02d ",time_remaining/60,time_remaining%60);
         gtk_label_set_text(active_label,buffer);
 
