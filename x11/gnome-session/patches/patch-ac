$NetBSD: patch-ac,v 1.8 2006/09/15 15:18:16 jmmv Exp $

--- gnome-session/main.c.orig	2006-07-26 14:46:36.000000000 +0200
+++ gnome-session/main.c
@@ -43,6 +43,7 @@
 #include "command.h"
 #include "splash-widget.h"
 #include "util.h"
+#include "gsm-dbus.h"
 #include "gsm-sound.h"
 #include "gsm-gsd.h"
 #include "gsm-keyring.h"
@@ -335,6 +336,7 @@ main (int argc, char *argv[])
   char **versions;
   GConfClient *gconf_client;
   GOptionContext *goption_context;
+  gboolean dbus_daemon_owner;
   
   if (getenv ("GSM_VERBOSE_DEBUG"))
     gsm_set_verbose (TRUE);
@@ -419,6 +421,7 @@ main (int argc, char *argv[])
   fprintf (stderr, "SESSION_MANAGER=%s\n", getenv ("SESSION_MANAGER"));
   gnome_window_icon_set_default_from_file (GNOME_ICONDIR"/gnome-session.png");
 
+  dbus_daemon_owner = gsm_dbus_daemon_start ();
 
   /* Make sure children see the right value for DISPLAY.  This is
      useful if --display was specified on the command line.  */
@@ -503,6 +506,9 @@ main (int argc, char *argv[])
 
   gsm_keyring_daemon_stop ();
 
+  if (dbus_daemon_owner)
+	gsm_dbus_daemon_stop ();
+
   g_object_unref (gconf_client);
   gsm_shutdown_gconfd ();
 
