$NetBSD: patch-ac,v 1.6 2006/04/01 17:36:41 jmmv Exp $

http://bugzilla.gnome.org/show_bug.cgi?id=336237

--- gnome-session/main.c.orig	2006-03-06 14:30:08.000000000 +0100
+++ gnome-session/main.c
@@ -43,6 +43,7 @@
 #include "command.h"
 #include "splash-widget.h"
 #include "util.h"
+#include "gsm-dbus.h"
 #include "gsm-sound.h"
 #include "gsm-gsd.h"
 #include "gsm-keyring.h"
@@ -334,6 +335,7 @@ main (int argc, char *argv[])
   int status;
   char *display_str;
   char **versions;
+  gboolean dbus_daemon_owner;
   
   if (getenv ("GSM_VERBOSE_DEBUG"))
     gsm_set_verbose (TRUE);
@@ -415,6 +417,7 @@ main (int argc, char *argv[])
   fprintf (stderr, "SESSION_MANAGER=%s\n", getenv ("SESSION_MANAGER"));
   gnome_window_icon_set_default_from_file (GNOME_ICONDIR"/gnome-session.png");
 
+  dbus_daemon_owner = gsm_dbus_daemon_start ();
 
   /* Make sure children see the right value for DISPLAY.  This is
      useful if --display was specified on the command line.  */
@@ -497,6 +500,9 @@ main (int argc, char *argv[])
   gsm_sound_logout ();
 
   gsm_keyring_daemon_stop ();
+
+  if (dbus_daemon_owner)
+    gsm_dbus_daemon_stop ();
   
   gsm_shutdown_gconfd ();
 
