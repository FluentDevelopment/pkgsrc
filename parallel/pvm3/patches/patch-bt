$NetBSD: patch-bt,v 1.1 2004/07/19 22:41:16 dmcmahill Exp $

--- pvmgs/Makefile.aimk.orig	Wed Feb 16 21:49:03 2000
+++ pvmgs/Makefile.aimk	Thu Mar 25 01:45:35 2004
@@ -58,15 +58,22 @@
 
 $(PVMXDIR)/pvm_gstat$(EXESFX):  pvm_gstat$(EXESFX)
+	${MKDIR} $(PVMXDIR)/.libs
+	-cp .libs/pvm_gstat$(EXESFX) $(PVMXDIR)/.libs
 	cp pvm_gstat$(EXESFX) $(PVMXDIR)
 
 $(PVMXDIR)/pvmgs$(EXESFX):  pvmgs$(EXESFX)
+	${MKDIR} $(PVMXDIR)/.libs
+	-cp .libs/pvmgs$(EXESFX) $(PVMXDIR)/.libs
 	cp pvmgs$(EXESFX) $(PVMXDIR)
 
 $(PVMXDIR)/pvmgroups$(EXESFX):  pvmgroups$(EXESFX)
+	${MKDIR} $(PVMXDIR)/.libs
+	-cp .libs/pvmgroups$(EXESFX) $(PVMXDIR)/.libs
 	cp pvmgroups$(EXESFX) $(PVMXDIR)
 
 $(PVMLDIR)/$(LIBGPVM):  $(LIBGPVM)
-	cp $(LIBGPVM) $(PVMLDIR)
-	case x$(HASRANLIB) in xt ) echo ranlib; ranlib $(PVMLDIR)/$(LIBGPVM) ;; esac
+	${MKDIR} $(PVMLDIR)/.libs
+	-cp .libs/* $(PVMLDIR)/.libs
+	cp $(LIBGPVM:.a=.*) $(PVMLDIR)
 
 $(PVMLDIR)/$(LIBGPVM)-mpp:  $(LIBGPVM)-mpp
@@ -76,16 +83,21 @@
 
 $(PVMLDIR)/pvmgs$(EXESFX):  pvmgs$(EXESFX)
+	${MKDIR} $(PVMLDIR)/.libs
+	-cp .libs/pvmgs$(EXESFX) $(PVMLDIR)/.libs
 	cp pvmgs$(EXESFX) $(PVMLDIR)
 
+LTCC=	${LIBTOOL} --mode=compile ${CC}
+
 pvmgroups$(EXESFX):	pvmgroups.o $(LIBGPVM) $(PVMLIBDEP)
-	$(CC) $(CFLAGS) -o $@ pvmgroups.o $(LIBGPVM) $(LIBS) 
+	$(LIBTOOL) --mode=link $(CC) ${PVM_STATIC} $(CFLAGS) -o $@ pvmgroups.lo $(LIBGPVM:.a=.la) $(LIBS) 
 
 pvmgs$(EXESFX):	$(DOBJ) $(PVMLIBDEP)
-	$(CC) $(CFLAGS) -o $@ $(DOBJ) $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) ${PVM_STATIC} $(CFLAGS) -o $@ $(DOBJ:.o=.lo) $(LIBS)
 
 $(LIBGPVM):	$(LOBJ)
 	rm -f $(LIBGPVM)
-	$(AR) cr $(LIBGPVM) $(LOBJ)
-	case x$(HASRANLIB) in xt ) echo ranlib; ranlib $(LIBGPVM) ;; esac
+	${LIBTOOL} --mode=link ${CC} ${PVM_STATIC} -o ${.TARGET:.a=.la} ${LOBJ:.o=.lo} \
+		-rpath ${PVM_DIR}/lib/$(PVM_ARCH) \
+		-version-info ${PVMLIB_VER}
 
 $(LIBGPVM)-mpp:	$(LOBJ)
@@ -96,5 +108,5 @@
 
 pvm_gstat$(EXESFX): pvm_gstat.o $(LIBGPVM) $(PVMLIBDEP)
-	$(CC) $(CFLAGS) -o $@ pvm_gstat.o $(LIBGPVM) $(LIBS)
+	$(LIBTOOL) --mode=link $(CC) ${PVM_STATIC} $(CFLAGS) -o $@ pvm_gstat.lo $(LIBGPVM:.a=.la) $(LIBS)
 
 clean:
@@ -111,15 +123,15 @@
 #
 pvmgsu_core.o:	$(SDIR)/pvmgsu_core.c
-	$(CC) $(CFLAGS) -c $(SDIR)/pvmgsu_core.c
+	$(LTCC) $(CFLAGS) -c $(SDIR)/pvmgsu_core.c
 pvmgsu_aux.o:	$(SDIR)/pvmgsu_aux.c
-	$(CC) $(CFLAGS) -c $(SDIR)/pvmgsu_aux.c
+	$(LTCC) $(CFLAGS) -c $(SDIR)/pvmgsu_aux.c
 pvmgroups.o:	$(SDIR)/pvmgroups.c
-	$(CC) $(CFLAGS) -c $(SDIR)/pvmgroups.c
+	$(LTCC) $(CFLAGS) -c $(SDIR)/pvmgroups.c
 pvm_gstat.o:	$(SDIR)/pvm_gstat.c
-	$(CC) $(CFLAGS) -c $(SDIR)/pvm_gstat.c
+	$(LTCC) $(CFLAGS) -c $(SDIR)/pvm_gstat.c
 pvmgs_core.o:	$(SDIR)/pvmgs_core.c
-	$(CC) $(CFLAGS) -c $(SDIR)/pvmgs_core.c
+	$(LTCC) $(CFLAGS) -c $(SDIR)/pvmgs_core.c
 pvmgs_func.o:	$(SDIR)/pvmgs_func.c
-	$(CC) $(CFLAGS) -c $(SDIR)/pvmgs_func.c
+	$(LTCC) $(CFLAGS) -c $(SDIR)/pvmgs_func.c
 
 #
