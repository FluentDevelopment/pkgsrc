$NetBSD: patch-ad,v 1.7 2005/07/13 18:39:58 kristerw Exp $

--- src/mesa/Makefile.orig	2004-10-04 09:44:50.000000000 -0500
+++ src/mesa/Makefile
@@ -12,10 +12,10 @@ GL_TINY = 0$(MESA_MAJOR)0$(MESA_MINOR)0$
 
 
 .c.o:
-	$(CC) -c $(INCLUDE_DIRS) $(CFLAGS) $< -o $@
+	${LIBTOOL} --mode=compile $(CC) -c $(INCLUDE_DIRS) $(CFLAGS) $< -o $@
 
 .S.o:
-	$(CC) -c $(INCLUDE_DIRS) $(CFLAGS) $< -o $@
+	${LIBTOOL} --mode=compile $(CC) -c $(INCLUDE_DIRS) $(CFLAGS) $< -o $@
 
 
 # Figure out what to make here
@@ -112,22 +112,23 @@ subdirs:
 
 # Make the GL library
 $(LIB_DIR)/$(GL_LIB_NAME): $(STAND_ALONE_OBJECTS)
-	CC=$(CC) CXX=$(CXX) $(TOP)/bin/mklib -o $(GL_LIB) -major $(GL_MAJOR) \
-		-minor $(GL_MINOR) -patch $(GL_TINY) -install $(LIB_DIR) \
-		$(MKLIB_OPTIONS) $(GL_LIB_DEPS) $(STAND_ALONE_OBJECTS)
+	${LIBTOOL} --mode=link ${CC} -o ${GL_LIB_NAME:.so=.la} \
+		${STAND_ALONE_OBJECTS:.o=.lo} \
+		-rpath ${PREFIX}/lib -version-info ${GL_MAJOR}:${GL_MINOR} \
+		-L${X11BASE}/lib ${GL_LIB_DEPS} -R ${X11BASE}/lib
 
 # Make the OSMesa library
 $(LIB_DIR)/$(OSMESA_LIB_NAME): $(OSMESA_DRIVER_OBJECTS) $(OSMESA16_OBJECTS)
 	if [ "${DRIVER_DIRS}" = "osmesa" ] ; then \
-		CC=$(CC) CXX=$(CXX) $(TOP)/bin/mklib -o $(OSMESA_LIB) -major $(MESA_MAJOR) \
-			-minor $(MESA_MINOR) -patch $(MESA_TINY) \
-			-install $(LIB_DIR) $(MKLIB_OPTIONS) \
-			$(OSMESA_LIB_DEPS) $(OSMESA16_OBJECTS) ; \
+	    ${LIBTOOL} --mode=link ${CC} -o ${OSMESA_LIB_NAME:.so=.la} \
+		${OSMESA16_OBJECTS:.o=.lo} -rpath ${PREFIX}/lib \
+		-version-info ${MESA_MAJOR}:${MESA_MINOR} \
+		${OSMESA_LIB_DEPS:M-l*:S|-lGL|libGL.la|} ; \
 	else \
-		CC=$(CC) CXX=$(CXX) $(TOP)/bin/mklib -o $(OSMESA_LIB) -major $(MESA_MAJOR) \
-			-minor $(MESA_MINOR) -patch $(GL_TINY) \
-			-install $(LIB_DIR) $(MKLIB_OPTIONS) \
-			$(OSMESA_LIB_DEPS) $(OSMESA_DRIVER_OBJECTS) ; \
+	    ${LIBTOOL} --mode=link ${CC} -o ${OSMESA_LIB_NAME:.so=.la} \
+		${OSMESA_DRIVER_OBJECTS:.o=.lo} -rpath ${PREFIX}/lib \
+		-version-info ${MESA_MAJOR}:${MESA_MINOR} \
+		${OSMESA_LIB_DEPS:M-l*:S|-lGL|libGL.la|} ; \
 	fi
 
 
