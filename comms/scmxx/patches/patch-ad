$NetBSD: patch-ad,v 1.1 2002/01/17 19:35:41 kleink Exp $

--- common.c.orig	Fri Jan  4 21:43:54 2002
+++ common.c	Thu Jan 17 20:14:15 2002
@@ -26,6 +26,42 @@
 	else{errexit("Buffer overflow. Set a greater length in device.h and recompile.\n");}
 }
 
+void set_ttyspeed(char *newttyspeed){
+	if (string_to_speed(newttyspeed, &myttyspeed) != 0){
+		errexit("Cannot set device speed.\n");
+	}
+}
+
+int string_to_speed(const char *speedstring_p, speed_t *speed_p)
+{
+	int nspeed;
+	speed_t bspeed;
+
+	nspeed = atoi(speedstring_p);
+	switch(nspeed){
+		case 19200:
+			bspeed=B19200;
+			break;
+		case 38400:
+			bspeed=B38400;
+			break;
+#ifdef B57600
+		case 57600:
+			bspeed=B57600;
+			break;
+#endif
+#ifdef B115200
+		case 115200:
+			bspeed=B115200;
+			break;
+#endif
+		default:
+			return(-1);
+	}
+	*speed_p=bspeed;
+	return(0);
+}
+	
 void new_at_command(char *at_command_p, char *addon_p){
 		memset(at_command_p,0,sizeof(at_command_p));
 		strcpy(&at_command_p[0],"AT");
@@ -63,8 +99,8 @@
 		fprintf(stderr,"Error in getting device attributes.\n");
 		exit(1);
 	}
-	cfsetispeed(&newtio, B19200); //input at baudrate
-	cfsetospeed(&newtio, B19200); //ouput at baudrate
+	cfsetispeed(&newtio, myttyspeed); //input at baudrate
+	cfsetospeed(&newtio, myttyspeed); //ouput at baudrate
 	newtio.c_cflag &= ~(CSIZE|CSTOPB|PARENB|PARODD|CRTSCTS);
 	newtio.c_cflag |= CS8 | CLOCAL | CREAD | HUPCL; //8bit, local mode, read data
 	newtio.c_lflag &= ~(ECHO|ECHOE|ECHOPRT|ECHOK|ECHOKE|ECHONL|ECHOCTL|
@@ -75,7 +111,10 @@
 	newtio.c_iflag |= IGNPAR;
 	newtio.c_oflag &= ~OPOST;
 	tcflush(mytty, TCIOFLUSH); //clear serial tty
-	tcsetattr(mytty,TCSANOW,&newtio); //set now
+	if (tcsetattr(mytty,TCSANOW,&newtio) != 0){ //set now
+		perror("Error in setting device attributes");
+		exit(1);
+	}
 	alarm(0);
 }
 
