$NetBSD: patch-ac,v 1.2 2004/05/25 21:49:26 wiz Exp $

--- Makefile.orig	2003-09-28 17:26:39.000000000 +0200
+++ Makefile
@@ -6,8 +6,7 @@ include config.mak
 
 VPATH=$(SRC_PATH)
 
-CFLAGS= $(OPTFLAGS) -Wall -g -I. -I$(SRC_PATH) -I$(SRC_PATH)/libavcodec -I$(SRC_PATH)/libavformat -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_GNU_SOURCE
-LDFLAGS+= -g 
+CFLAGS= $(OPTFLAGS) -Wall -I. -I$(SRC_PATH) -I$(SRC_PATH)/libavcodec -I$(SRC_PATH)/libavformat -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_GNU_SOURCE
 
 ifeq ($(TARGET_GPROF),yes)
 CFLAGS+=-p
@@ -42,6 +41,8 @@ ifeq ($(CONFIG_VORBIS),yes)
 EXTRALIBS+=-logg -lvorbis -lvorbisenc
 endif
 
+EXTRALIBS+=${LIBOSSAUDIO}
+
 ifeq ($(CONFIG_FAAD),yes)
 ifeq ($(CONFIG_FAADBIN),yes)
 # no libs needed
@@ -64,7 +65,7 @@ endif
 
 OBJS = ffmpeg.o ffserver.o cmdutils.o ffplay.o
 SRCS = $(OBJS:.o=.c) $(ASM_OBJS:.o=.s)
-FFLIBS = -L./libavformat -lavformat -L./libavcodec -lavcodec
+FFLIBS = libavformat/libavformat.la libavcodec/libavcodec.la
 
 all: lib $(PROG) $(PROGTEST) $(VHOOK)
 
@@ -72,42 +73,34 @@ lib:
 	$(MAKE) -C libavcodec all
 	$(MAKE) -C libavformat all
 
-ffmpeg_g$(EXESUF): ffmpeg.o cmdutils.o .libs
-	$(CC) $(LDFLAGS) -o $@ ffmpeg.o cmdutils.o $(FFLIBS) $(EXTRALIBS)
-
-ffmpeg$(EXESUF): ffmpeg_g$(EXESUF)
-	cp -p $< $@
-	$(STRIP) $@
-
-ffserver$(EXESUF): ffserver.o .libs
-	$(CC) $(LDFLAGS) $(FFSLDFLAGS) -o $@ ffserver.o $(FFLIBS) $(EXTRALIBS) 
+ffmpeg$(EXESUF): ffmpeg.o cmdutils.o .ffmpeglibs
+	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) -o $@ ffmpeg.o cmdutils.o $(FFLIBS) $(EXTRALIBS)
 
-ffplay_g$(EXESUF): ffplay.o cmdutils.o .libs
-	$(CC) $(LDFLAGS) -o $@ ffplay.o cmdutils.o $(FFLIBS) $(EXTRALIBS) $(SDL_LIBS)
+ffserver$(EXESUF): ffserver.o .ffmpeglibs
+	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) $(FFSLDFLAGS) -o $@ ffserver.o $(FFLIBS) $(EXTRALIBS) 
 
-ffplay$(EXESUF): ffplay_g$(EXESUF)
-	cp -p $< $@
-	$(STRIP) $@
+ffplay$(EXESUF): ffplay.o cmdutils.o .ffmpeglibs
+	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) -o $@ ffplay.o cmdutils.o $(FFLIBS) $(EXTRALIBS) $(SDL_LIBS)
 
-output_example$(EXESUF): output_example.o .libs
-	$(CC) $(LDFLAGS) -o $@ output_example.o $(FFLIBS) $(EXTRALIBS)
+output_example$(EXESUF): output_example.o .ffmpeglibs
+	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) -o $@ output_example.o $(FFLIBS) $(EXTRALIBS)
 
 ffplay.o: ffplay.c
 	$(CC) $(CFLAGS) $(SDL_CFLAGS) -c -o $@ $< 
 
 %.o: %.c
-	$(CC) $(CFLAGS) -c -o $@ $< 
+	$(CC) -DFFSERVER_CONF=\"$(FFSERVER_CONF)\" $(CFLAGS) -c -o $@ $<
 
-videohook: .libs
+videohook: .ffmpeglibs
 	$(MAKE) -C vhook all
 
 .PHONY: install
 
 install: all install-man $(INSTALLVHOOK)
-	$(MAKE) -C libavcodec install
-	$(MAKE) -C libavformat install
+	$(MAKE) -C libavcodec install install-headers
+	$(MAKE) -C libavformat install install-headers
 	install -d "$(bindir)"
-	install -c -s -m 755 $(PROG) "$(bindir)"
+	$(LIBTOOL) --mode=install $(BSD_INSTALL_PROGRAM) $(PROG) "$(bindir)"
 
 # create the window installer
 wininstaller: all install
@@ -145,15 +138,15 @@ endif
 .depend: $(SRCS)
 	$(CC) -MM $(CFLAGS) $^ 1>.depend
 
-.libs: lib
-	@test -f .libs || touch .libs
-	@for i in $(DEP_LIBS) ; do if $(TEST) $$i -nt .libs ; then touch .libs; fi ; done
+.ffmpeglibs: lib
+	@test -f .ffmpeglibs || touch .ffmpeglibs
+	@for i in $(DEP_LIBS) ; do if $(TEST) $$i -nt .ffmpeglibs ; then touch .ffmpeglibs; fi ; done
 
 clean: $(CLEANVHOOK)
 	$(MAKE) -C libavcodec clean
 	$(MAKE) -C libavformat clean
 	$(MAKE) -C tests clean
-	rm -f *.o *.d *~ .libs .depend gmon.out TAGS ffmpeg_g$(EXESUF) ffplay_g$(EXESUF) $(PROG) $(PROGTEST)
+	rm -f *.o *.d *~ .ffmpeglibs .depend gmon.out TAGS ffmpeg_g$(EXESUF) ffplay_g$(EXESUF) $(PROG) $(PROGTEST)
 
 clean-vhook:
 	$(MAKE) -C vhook clean
