# $NetBSD: Makefile,v 1.103 2002/09/11 11:34:21 jlam Exp $

MOZ_VER=	1.1
DISTNAME=	mozilla-source-${MOZ_VER}
PKGNAME=	mozilla-${MOZ_VER}
PKGREVISION=	1
WRKSRC=		${WRKDIR}/mozilla
CATEGORIES=	www
MASTER_SITES=	${MASTER_SITE_MOZILLA:=mozilla${MOZ_VER}/src/}
EXTRACT_SUFX=	.tar.gz

MAINTAINER=	taya@netbsd.org
HOMEPAGE=	http://www.mozilla.org/
COMMENT=	Open-source version of the Netscape browser

BUILD_DEPENDS+=	zip>=2.3:../../archivers/zip
BUILD_DEPENDS+=	autoconf-2.13:../../devel/autoconf

USE_BUILDLINK2=	yes
USE_PERL5=	build
USE_GMAKE=	yes
USE_X11BASE=	yes
GNU_CONFIGURE=	yes
CONFIGURE_ARGS=	--disable-tests \
		--disable-debug \
		--with-system-jpeg=${BUILDLINK_PREFIX.jpeg} \
		--with-system-png=${BUILDLINK_PREFIX.png} \
		--enable-mathml \
		--enable-crypto \
		--enable-svg

SHAREMODE?=	644
ALL_TARGET=	# empty

UNLIMIT_RESOURCES=	datasize memorysize stacksize

.include	"../../graphics/freetype2/buildlink2.mk"
.include	"../../graphics/gdk-pixbuf/buildlink2.mk"
.include	"../../graphics/jpeg/buildlink2.mk"
.include	"../../graphics/png/buildlink2.mk"
.include	"../../net/ORBit/buildlink2.mk"
.include	"../../x11/gtk/buildlink2.mk"

# NetBSD-*-m68k builds, but "regchrome" dumps core.
NOT_FOR_PLATFORM=	NetBSD-1.4.*-* NetBSD-*-m68k

MOZILLA=	mozilla
MOZ_LIBDIR=	${PREFIX}/lib/${MOZILLA}
MAKE_ENV+=	LIBRUNPATH=${MOZ_LIBDIR}
CONFIGURE_ENV+=	LIBRUNPATH=${MOZ_LIBDIR}
MAKE_ENV+=	MOZ_INTERNAL_LIBART_LGPL=1
CONFIGURE_ENV+=	MOZ_INTERNAL_LIBART_LGPL=1
LDFLAGS+=	-Wl,-R${MOZ_LIBDIR}

# avoid creating a .mozilla directory in the users home
# directory
SCRIPTS_ENV+=	HOME="${WRKDIR}"

PLIST_SUBST+=	MOZILLA="${MOZILLA}"
.if ${OBJECT_FMT} == "ELF"
SO_SUFFIX=	"so"
.else
SO_SUFFIX=	"so.1.0"
.endif
PLIST_SUBST+=	SO_SUFFIX=${SO_SUFFIX}

SCRIPTS_ENV+=	OBJECT_FMT=${OBJECT_FMT}
SCRIPTS_ENV+=	PLIST_SRC=${PLIST_SRC}
SCRIPTS_ENV+=	SED=${SED}
SCRIPTS_ENV+=	RM=${RM}
SCRIPTS_ENV+=	EGREP=${EGREP}
SCRIPTS_ENV+=	CHOWN=${CHOWN}
SCRIPTS_ENV+=	CHGRP=${CHGRP}
SCRIPTS_ENV+=	CHMOD=${CHMOD}
SCRIPTS_ENV+=	BINOWN=${BINOWN}
SCRIPTS_ENV+=	BINGRP=${BINGRP}
SCRIPTS_ENV+=	BINMODE=${BINMODE}
SCRIPTS_ENV+=	SETENV=${SETENV}
SCRIPTS_ENV+=   MOZILLA=${MOZILLA}
SCRIPTS_ENV+=	SO_SUFFIX=${SO_SUFFIX}

PTHREAD_OPTS+=	native optional

COPTS?=			-O2
CONFIGURE_ARGS+=	--enable-optimize="${COPTS}"

XPTCFILES+=	xptcinvoke_asm_sparc64_netbsd.s xptcstubs_asm_sparc64_netbsd.s
XPTCFILES+=	xptcinvoke_sparc64_netbsd.cpp xptcstubs_sparc64_netbsd.cpp

post-extract:
.for F in ${XPTCFILES}
	${CP} ${FILESDIR}/${F} ${WRKSRC}/xpcom/reflect/xptcall/src/md/unix/${F}
.endfor

pre-configure:
	cd ${WRKSRC} && autoconf

post-build:
	${ECHO} skin,install,select,classic/1.0 >> ${WRKSRC}/dist/bin/chrome/installed-chrome.txt
	${ECHO} locale,install,select,en-US >> ${WRKSRC}/dist/bin/chrome/installed-chrome.txt

do-install:
	${SETENV} ${SCRIPTS_ENV} ${SH} ${FILESDIR}/moz-install

.include "../../mk/pthread.buildlink2.mk"

.if defined(PTHREAD_TYPE) && (${PTHREAD_TYPE} == "none")
CONFIGURE_ARGS+= --without-pthreads
.endif

.include "../../mk/bsd.pkg.mk"
