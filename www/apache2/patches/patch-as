$NetBSD: patch-as,v 1.3 2004/09/07 19:43:03 adrianp Exp $

--- modules/ssl/ssl_engine_io.c.orig	2004-09-06 18:25:31.000000000 +0000
+++ modules/ssl/ssl_engine_io.c	2004-09-06 18:27:21.000000000 +0000
@@ -562,8 +562,12 @@
         *len = bytes;
         if (inctx->mode == AP_MODE_SPECULATIVE) {
             /* We want to rollback this read. */
-            inctx->cbuf.value -= bytes;
-            inctx->cbuf.length += bytes;
+            if (inctx->cbuf.length > 0) {
+                inctx->cbuf.value -= bytes;
+                inctx->cbuf.length += bytes;
+            } else {
+                char_buffer_write(&inctx->cbuf, buf, (int)bytes);
+            }
             return APR_SUCCESS;
         }
         /* This could probably be *len == wanted, but be safe from stray
@@ -587,6 +591,10 @@
     while (1) {
 
         if (!inctx->filter_ctx->pssl) {
+            /* Ensure a non-zero error code is returned */
+            if (inctx->rc == APR_SUCCESS) {
+                inctx->rc = APR_EGENERAL;
+            }
             break;
         }
 
