$NetBSD: patch-ac,v 1.1 2001/08/21 20:09:59 tron Exp $

--- src/mozilla.cpp.orig	Thu Aug 16 18:03:34 2001
+++ src/mozilla.cpp	Thu Aug 16 19:21:01 2001
@@ -1046,6 +1046,28 @@
  * into a form which mozilla can use.
  * @locStr: The unicode string to encode
  */
+size_t
+my_mbstowcs(wchar_t *pwcs, const char *s, int n)
+{
+   int count = 0;
+   
+   if (pwcs != NULL) {
+      do {
+	 if ((*pwcs++ = (wchar_t) *s++) == 0)
+	   break;
+	 count++;
+      } while (--n != 0);
+   } else {
+      do {
+	 if (((wchar_t)*s++) == 0)
+	   break;
+	 count++;
+      } while (--n != 0);
+   }
+   
+   return count;
+}
+
 extern "C" PRUnichar *
 mozilla_locale_to_unicode (const gchar *locStr)
 {
@@ -1060,7 +1082,9 @@
 	}
 
 	/* count the number of wide characters which will be produced */
-	count = mbstowcs (NULL, locStr, 0);
+        // Until NetBSD fixes their busted libc
+        count = my_mbstowcs (NULL, locStr, 0);
+   
 	if (count == -1)
 	{
 		/* hmm, shouldnt happen but fallback to utf8 */
@@ -1070,7 +1094,7 @@
 
 	/* allocate and decode */
 	wide = g_new0 (wchar_t, count + 1);
-	mbstowcs (wide, locStr, count + 1);
+        my_mbstowcs (wide, locStr, count + 1);  // Until NetBSD fixes their busted libc
 
 	/* make a unicode string and copy into it */
 	uniStr = g_new0 (PRUnichar, count + 1);
