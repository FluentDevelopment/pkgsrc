# $NetBSD: Makefile,v 1.43 2004/05/05 15:37:25 abs Exp $

DISTNAME=       jakarta-tomcat-${TOMCAT_VERSION}
PKGREVISION=	1
WRKSRC=		${WRKDIR}/${DISTNAME}
CATEGORIES=	www java
# The list of sites to download is generated by a jakarta website.
# The getsite.sh script parses the HTML and extracts the urls.
DYNAMIC_MASTER_SITES=1

MAINTAINER=	erh@NetBSD.org
HOMEPAGE=	http://jakarta.apache.org/tomcat/
COMMENT=	The Apache Project's Java Servlet 2.4 and JSP 2.0 server

TOMCAT_VERSION=	5.0.19

# This needs java 1.4 or higher.
USE_JAVA=yes
USE_JAVA2=yes

USE_BUILDLINK2=	yes

TOMCAT_LIB=     ${PREFIX}/tomcat

SAMPLECONFDIR=			${TOMCAT_LIB}/conf
PKG_SYSCONFDIR.jakarta-tomcat=	${SAMPLECONFDIR}

USE_PKGINSTALL=	yes
CFILES=		server.xml web.xml tomcat-users.xml
CFILES+=	catalina.policy catalina.properties jk2.properties
CFILES+=	Catalina/localhost/admin.xml
CFILES+=	Catalina/localhost/balancer.xml
CFILES+=	Catalina/localhost/manager.xml

CONF_FILES=	# empty
.for FILE in ${CFILES}
CONF_FILES+=	${SAMPLECONFDIR}/${FILE}.default ${PKG_SYSCONFDIR}/${FILE}
.endfor
RCD_SCRIPTS=	tomcat

FILES_SUBST+=	JAVA_HOME=${PKG_JAVA_HOME} TOMCAT_LIB=${TOMCAT_LIB}

.include "../../mk/java-vm.mk"

do-build:
.for FILE in ${CFILES}
	${MV} -f ${WRKSRC}/conf/${FILE} ${WRKSRC}/conf/${FILE}.default
.endfor

do-install:
	${INSTALL_DATA_DIR} ${TOMCAT_LIB}
	cd ${WRKSRC} && ${PAX} -rw -pm . ${TOMCAT_LIB}
	@${FIND} ${TOMCAT_LIB} -type f -print \
		| ${XARGS} ${CHMOD} a+r
	@${FIND} ${TOMCAT_LIB} \( -type f -o -perm -u+x \) -print \
		| ${XARGS} ${CHMOD} a+rx
	@${FIND} ${TOMCAT_LIB} -type d -print \
		| ${XARGS} ${CHMOD} a+rx

.include "../../mk/bsd.pkg.mk"
