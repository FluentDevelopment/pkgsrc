# $NetBSD: Makefile,v 1.8 2005/12/29 06:22:23 jlam Exp $

PKGNAME=	jakarta-tomcat5-${TOMCAT_VERSION}
DISTNAME=	jakarta-tomcat-${TOMCAT_VERSION}
PKGREVISION=	1
CATEGORIES=	www java
# The list of sites to download is generated by a jakarta website.
# The getsite.sh script parses the HTML and extracts the urls.
DYNAMIC_MASTER_SITES=1

MAINTAINER=	erh@NetBSD.org
HOMEPAGE=	http://jakarta.apache.org/tomcat/
COMMENT=	The Apache Project's Java Servlet 2.4 and JSP 2.0 server

TOMCAT_VERSION= 5.0.30

# This needs java 1.4 or higher.
USE_JAVA2=	yes

TOMCAT_LIB=	${PREFIX}/tomcat5
CATALINA_DIR=	Catalina/localhost

EGDIR=		${TOMCAT_LIB}/share/examples/jakarta-tomcat
EGDIR2=		${EGDIR}/${CATALINA_DIR}

USE_TOOLS+=	gunzip tar

# Work around a horrible interaction with the gzip in NetBSD 2.0 (at least RC4)
# If gzip is used in a pipeline the tarfile fails to extract. PR bin/27228
EXTRACT_CMD=	${CP} ${DOWNLOADED_DISTFILE} ${WRKDIR}/tar.gz && ${GUNZIP_CMD} ${WRKDIR}/tar.gz && ${TAR} xf ${WRKDIR}/tar

PKG_SYSCONFDIR.jakarta-tomcat5= ${TOMCAT_LIB}/conf
MAKE_DIRS=	${PKG_SYSCONFDIR.jakarta-tomcat5}/${CATALINA_DIR}

RCD_SCRIPTS=	tomcat5
CFILES=		server.xml web.xml tomcat-users.xml
CFILES+=	catalina.policy catalina.properties jk2.properties
CF2FILES=	admin.xml balancer.xml manager.xml

CONF_FILES=	# empty
.for f in ${CFILES}
CONF_FILES+=	${EGDIR}/${f} ${PKG_SYSCONFDIR}/${f}
.endfor
.for f in ${CF2FILES}
CONF_FILES+=	${EGDIR2}/${f} ${PKG_SYSCONFDIR}/${CATALINA_DIR}/${f}
.endfor

FILES_SUBST+=	JAVA_HOME=${PKG_JVM_HOME:Q} TOMCAT_LIB=${TOMCAT_LIB:Q}

do-build:
	@${MV} ${WRKSRC}/conf ${WRKDIR}
do-install:
	${INSTALL_DATA_DIR} ${EGDIR2}
.for f in ${CFILES}
	${INSTALL_DATA} ${WRKDIR}/conf/${f} ${EGDIR}
.endfor
.for f in ${CF2FILES}
	${INSTALL_DATA} ${WRKDIR}/conf/${CATALINA_DIR}/${f} ${EGDIR2}
.endfor
	${INSTALL_DATA_DIR} ${TOMCAT_LIB}
	@(cd ${WRKSRC} && ${PAX} -rw -pm . ${TOMCAT_LIB};		\
	${FIND} ${TOMCAT_LIB} -type f -print | ${XARGS} ${CHMOD} a+r;	\
	${FIND} ${TOMCAT_LIB} \( -type f -o -perm -u+x \) -print	\
		| ${XARGS} ${CHMOD} a+rx;				\
	${FIND} ${TOMCAT_LIB} -type d -print | ${XARGS} ${CHMOD} a+rx;	\
	${FIND} ${TOMCAT_LIB} -type f -name \*.bat -print |		\
		${XARGS} ${RM} -f)

.include "../../mk/java-vm.mk"
.include "../../mk/bsd.pkg.mk"
