$NetBSD: patch-aa,v 1.4 2001/07/14 03:51:14 jlam Exp $

--- Makefile.orig	Fri Jun 23 16:34:47 2000
+++ Makefile	Fri Jul 13 23:48:52 2001
@@ -1,8 +1,9 @@
 
 SHELL=/bin/sh
-CC=gcc
+CC=${LIBTOOL} ${REALCC}
+LD=${LIBTOOL} ${REALCC}
 BIGFILES=-D_FILE_OFFSET_BITS=64
-CFLAGS=-Wall -Winline -O2 -fomit-frame-pointer -fno-strength-reduce $(BIGFILES)
+CFLAGS+=-Wall -Winline -fomit-frame-pointer -fno-strength-reduce $(BIGFILES)
 
 OBJS= blocksort.o  \
       huffman.o    \
@@ -12,22 +13,18 @@
       decompress.o \
       bzlib.o
 
-all: libbz2.a bzip2 bzip2recover test
+all: libbz2.la bzip2 bzip2recover test
 
-bzip2: libbz2.a bzip2.o
-	$(CC) $(CFLAGS) -o bzip2 bzip2.o -L. -lbz2
+bzip2: libbz2.la bzip2.o
+	$(CC) $(CFLAGS) -static -o bzip2 bzip2.o libbz2.la
 
 bzip2recover: bzip2recover.o
-	$(CC) $(CFLAGS) -o bzip2recover bzip2recover.o
+	$(CC) $(CFLAGS) -static -o bzip2recover bzip2recover.o
 
-libbz2.a: $(OBJS)
-	rm -f libbz2.a
-	ar cq libbz2.a $(OBJS)
-	@if ( test -f /usr/bin/ranlib -o -f /bin/ranlib -o \
-		-f /usr/ccs/bin/ranlib ) ; then \
-		echo ranlib libbz2.a ; \
-		ranlib libbz2.a ; \
-	fi
+libbz2.la: $(OBJS)
+	rm -f libbz2.la
+	$(LD) $(LDFLAGS) -o libbz2.la $(OBJS:.o=.lo) -version-info 0:0	\
+		-rpath $(PREFIX)/lib
 
 test: bzip2
 	@cat words1
@@ -44,8 +41,6 @@
 	cmp sample2.tst sample2.ref
 	cmp sample3.tst sample3.ref
 	@cat words3
-
-PREFIX=/usr
 
 install: bzip2 bzip2recover
 	if ( test ! -d $(PREFIX)/bin ) ; then mkdir $(PREFIX)/bin ; fi
