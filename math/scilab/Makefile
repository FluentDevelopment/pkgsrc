# $NetBSD: Makefile,v 1.23 2001/07/11 15:16:20 dmcmahill Exp $
#

DISTNAME=	scilab-2.6.src
PKGNAME=	scilab-2.6nb1
WRKSRC=		${WRKDIR}/${DISTNAME:.src=}
CATEGORIES=	math
MASTER_SITES=	ftp://ftp.inria.fr/INRIA/Projects/Meta2/Scilab/distributions/

MAINTAINER=	dmcmahill@netbsd.org
HOMEPAGE=	http://www-rocq.inria.fr/scilab/
COMMENT=	High-level scientific math programming environment with graphics

DEPENDS+=	xless-*:../../x11/xless
DEPENDS+=	pvm-3.4.3:../../parallel/pvm3

# needs full floating point math.  Once the FPC code for alpha is integrated
# this line can be changed to only exclude older versions of the operating
# system.
NOT_FOR_PLATFORM=	*-*-alpha

USE_FORTRAN=		yes
USE_LIBTOOL=		yes
LTCONFIG_OVERRIDE=	${WRKSRC}/config/ltconfig
USE_X11BASE=		yes
USE_X11=		yes
GNU_CONFIGURE=		yes

CONFIGURE_ARGS+=	--without-xless --with-xaw
#override HOME to avoid picking up a bad ${HOME}/.scilab during the build
MAKE_ENV+=	HOME=${WRKSRC} PVM_ROOT=${PVM_ROOT}
CONFIGURE_ENV+=	LOCALBASE=${LOCALBASE}
PVM_ROOT?=	${LOCALBASE}/pvm3
CONFIGURE_ENV+=	PVM_ROOT=${PVM_ROOT}
CONFIGURE_ENV+=	X11BASE=${X11BASE}

# remove some stuff which is broken in the distfile.  The config's
# are links to ../config (ie circular).
post-extract:
	${RM} ${WRKSRC}/config.cache
	${RM} ${WRKSRC}/examples/callsci/callsciJava/config/config
	${RM} ${WRKSRC}/examples/callsci/callsciFortran/config/config
	${RM} ${WRKSRC}/examples/callsci/callsciC/config/config
	${RM} ${WRKSRC}/examples/callsci/callsciC++/config/config

# clean up any possible leftovers from 'make test' so that our PLIST
# will still be right
pre-install:
	cd ${WRKSRC}/tests && ${MAKE_PROGRAM} distclean
	cd ${WRKSRC}/examples && ${MAKE_PROGRAM} distclean

post-install:
	${INSTALL_DATA} ${PREFIX}/${PKGNAME}/X11_defaults/Xscilab \
		${X11BASE}/lib/X11/app-defaults
	${INSTALL_DATA} ${PREFIX}/${PKGNAME}/X11_defaults/Metanet-color \
		${X11BASE}/lib/X11/app-defaults
	${LN} -sf ${X11BASE}/bin/xless ${PREFIX}/${PKGNAME}/bin/xless

# the "SCI=0 && unset SCI" is done because some of the tests really will
# fail if SCI is set to anything.
test: build
	SCI=0 && unset SCI && cd ${WRKSRC}/tests && \
		${MAKE_ENV} ${MAKE_PROGRAM} tests 2>&1 | \
		 tee ${WRKDIR}/tests.log
	SCI=0 && unset SCI && cd ${WRKSRC}/examples && \
		${MAKE_ENV} ${MAKE_PROGRAM} tests 2>&1 | \
		tee ${WRKDIR}/examples.log

.include "../../mk/bsd.pkg.mk"
