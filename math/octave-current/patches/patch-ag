$NetBSD: patch-ag,v 1.4 2002/03/07 06:18:36 jmc Exp $

--- src/Makefile.in.orig	Thu Mar  7 00:07:18 2002
+++ src/Makefile.in	Thu Mar  7 05:14:39 2002
@@ -143,13 +143,7 @@
 OBJECTS_1 := $(patsubst %.c, %.o, $(OBJECTS_2))
 OBJECTS := $(patsubst %.cc, %.o, $(OBJECTS_1))
 
-ifeq ($(SHARED_LIBS), true)
-  ifdef CXXPICFLAG
-    PICOBJ := $(addprefix pic/, $(OBJECTS))
-  else
-    PICOBJ := $(OBJECTS)
-  endif
-endif
+PICOBJ := $(OBJECTS)
 
 # Ugh.
 
@@ -184,8 +178,8 @@
 
 DOC_FILES := $(sort $(DEF_FILES) $(patsubst %, %.df, $(VAR_FILES)))
 
-OCTAVE_LFLAGS = -L$(TOPDIR)/liboctave -L$(TOPDIR)/libcruft \
-  -L$(TOPDIR)/src $(RLD_FLAG)
+OCTAVE_LFLAGS = -L$(TOPDIR)/liboctave/.libs -L$(TOPDIR)/libcruft/.libs \
+  -L$(TOPDIR)/src/.libs $(RLD_FLAG)
 
 OCTAVE_LIBS = $(LIBOCTINTERP) $(LIBOCTAVE) $(SPECIAL_MATH_LIB) $(LIBCRUFT) \
   $(LIBPLPLOT) $(LIBREADLINE) $(LIBKPATHSEA) $(LIBGLOB) $(LIBDLFCN)
@@ -210,30 +204,13 @@
 
 XERBLA = ../libcruft/blas-xtra/xerbla.o
 
-ifeq ($(SHARED_LIBS), true)
-  ifeq ($(STATIC_LIBS), true)
-    LIBRARIES = liboctinterp.$(LIBEXT) liboctinterp.$(SHLEXT)
-  else
-    LIBRARIES = liboctinterp.$(SHLEXT)
-    XERBLA = ../libcruft/blas-xtra/pic/xerbla.o
-  endif
-else
-  ifeq ($(STATIC_LIBS), true)
-    LIBRARIES = liboctinterp.$(LIBEXT)
-  else
-    ## This is not going to work, but hey, you asked for it...
-    LIBRARIES =
-    XERBLA =
-  endif
-endif
+LIBRARIES = liboctinterp.$(LIBEXT)
 
 libraries: $(LIBRARIES)
 .PHONY: libraries
 
 liboctinterp.$(LIBEXT): $(OBJECTS)
-	rm -f $@
-	$(TEMPLATE_AR) $(TEMPLATE_ARFLAGS) $@ $^
-	$(RANLIB) $@
+	${LIBTOOL} --mode=link cc -o liboctinterp.la ${OBJECTS:.o=.lo} -rpath ${PREFIX}/lib -version-info ${version:2.1.%=2:%}
 
 liboctinterp.$(SHLEXT): liboctinterp.$(SHLEXT_VER)
 	rm -f $@
@@ -259,7 +236,7 @@
 	octave.o builtins.o ops.o $(XERBLA) $(DLD_STATIC_OBJ) \
 	$(OCTAVE_LFLAGS) \
 	$(OCTAVE_LIBS) \
-	$(LEXLIB) $(TERMLIBS) $(BLAS_LIBS) $(LIBS) $(FLIBS)
+	$(LEXLIB) $(TERMLIBS) $(BLAS_LIBS) $(LIBS) $(FLIBS) -lg2c
 
 stmp-pic: pic
 	@if [ -f stmp-pic ]; then \
@@ -288,6 +265,9 @@
 	@$(srcdir)/mkbuiltins def-files var-files > $@.t
 	@$(top_srcdir)/move-if-change $@.t $@
 
+parse.o: parse.cc
+	${LIBTOOL} --mode=compile $(CXX) -c $(CPPFLAGS) $(filter-out -O -O2,$(ALL_CXXFLAGS)) $< -o $@
+
 DOCSTRINGS: gendoc
 	./gendoc > $@.t
 	mv $@.t $@
@@ -344,20 +324,7 @@
 
 install-lib:
 	$(top_srcdir)/mkinstalldirs $(octlibdir)
-	if $(STATIC_LIBS); then \
-	  rm -f $(octlibdir)/liboctinterp.$(LIBEXT); \
-	  $(INSTALL_DATA) liboctinterp.$(LIBEXT) \
-	    $(octlibdir)/liboctinterp.$(LIBEXT); \
-	  $(RANLIB) $(octlibdir)/liboctinterp.$(LIBEXT); \
-	fi
-	if $(SHARED_LIBS); then \
-	  rm -f $(octlibdir)/liboctinterp.$(SHLEXT_VER); \
-	  $(INSTALL_PROGRAM) liboctinterp.$(SHLEXT_VER) \
-	    $(octlibdir)/liboctinterp.$(SHLEXT_VER); \
-	  cd $(octlibdir); \
-	  rm -f liboctinterp.$(SHLEXT); \
-	  $(LN_S) liboctinterp.$(SHLEXT_VER) liboctinterp.$(SHLEXT); \
-	fi
+	${LIBTOOL} --mode=install ${BSD_INSTALL_DATA} liboctinterp.la ${PREFIX}/lib
 	$(mk-libdir-link)
 .PHONY: install-lib
 
@@ -449,11 +416,6 @@
 .PHONY: bin-dist
 
 # Special rules -- these files need special things to be defined.
-
-parse.cc : parse.y
-	@echo "expect 11 shift/reduce conflicts"
-	$(YACC) $(YFLAGS) $<
-	@$(top_srcdir)/move-if-change y.tab.c $(@F)
 
 lex.cc : lex.l
 	$(LEX) $(LFLAGS) $< > $(@F)
