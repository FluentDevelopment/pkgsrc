$NetBSD: patch-ag,v 1.9 2004/01/21 06:56:48 martti Exp $

--- src/cleanup/cleanup.c.orig	2003-08-10 03:40:30.000000000 +0300
+++ src/cleanup/cleanup.c	2004-01-21 08:41:03.000000000 +0200
@@ -335,2 +335,3 @@
     single_server_main(argc, argv, cleanup_service,
+		       MAIL_SERVER_BOOL_TABLE, cleanup_bool_table,
 		       MAIL_SERVER_INT_TABLE, cleanup_int_table,
--- src/cleanup/cleanup.h.orig	2002-12-03 16:58:11.000000000 +0200
+++ src/cleanup/cleanup.h	2004-01-21 08:41:03.000000000 +0200
@@ -120,2 +120,3 @@
 extern void cleanup_post_jail(char *, char **);
+extern CONFIG_BOOL_TABLE cleanup_bool_table[];
 extern CONFIG_INT_TABLE cleanup_int_table[];
--- src/cleanup/cleanup_envelope.c.orig	2003-05-23 00:03:20.000000000 +0300
+++ src/cleanup/cleanup_envelope.c	2004-01-21 08:41:03.000000000 +0200
@@ -196,11 +196,15 @@
 	cleanup_rewrite_internal(clean_addr, *buf ? buf : var_empty_addr);
-	if (cleanup_rcpt_canon_maps)
-	    cleanup_map11_internal(state, clean_addr, cleanup_rcpt_canon_maps,
-				cleanup_ext_prop_mask & EXT_PROP_CANONICAL);
-	if (cleanup_comm_canon_maps)
-	    cleanup_map11_internal(state, clean_addr, cleanup_comm_canon_maps,
-				cleanup_ext_prop_mask & EXT_PROP_CANONICAL);
-	if (cleanup_masq_domains
-	    && (cleanup_masq_flags & CLEANUP_MASQ_FLAG_ENV_RCPT))
-	    cleanup_masquerade_internal(clean_addr, cleanup_masq_domains);
+	if (var_canon_env_rcpt) {
+	    if (cleanup_rcpt_canon_maps)
+		cleanup_map11_internal(state, clean_addr,
+				    cleanup_rcpt_canon_maps,
+				    cleanup_ext_prop_mask & EXT_PROP_CANONICAL);
+	    if (cleanup_comm_canon_maps)
+		cleanup_map11_internal(state, clean_addr,
+				    cleanup_comm_canon_maps,
+				    cleanup_ext_prop_mask & EXT_PROP_CANONICAL);
+	    if (cleanup_masq_domains
+		&& (cleanup_masq_flags & CLEANUP_MASQ_FLAG_ENV_RCPT))
+		cleanup_masquerade_internal(clean_addr, cleanup_masq_domains);
+	}
 	cleanup_out_recipient(state, state->orig_rcpt, STR(clean_addr));
--- src/cleanup/cleanup_init.c.orig	2002-12-03 16:56:56.000000000 +0200
+++ src/cleanup/cleanup_init.c	2004-01-21 08:41:03.000000000 +0200
@@ -8,2 +8,4 @@
 /*
+/*	CONFIG_BOOL_TABLE cleanup_bool_table[];
+/*
 /*	CONFIG_INT_TABLE cleanup_int_table[];
@@ -30,3 +32,3 @@
 /*
-/*	cleanup_{int,str,time}_table[] specify configuration
+/*	cleanup_{bool,int,str,time}_table[] specify configuration
 /*	parameters that must be initialized before calling any functions
@@ -111,2 +113,3 @@
 char   *var_masq_classes;		/* what to masquerade */
+bool    var_canon_env_rcpt;		/* canonicalize envelope recipient */
 int     var_qattr_count_limit;		/* named attribute limit */
@@ -147,2 +150,7 @@
 
+CONFIG_BOOL_TABLE cleanup_bool_table[] = {
+    VAR_CANON_ENV_RCPT, DEF_CANON_ENV_RCPT, &var_canon_env_rcpt,
+    0,
+};
+
  /*
--- src/global/mail_params.h.orig	2004-01-21 08:40:40.000000000 +0200
+++ src/global/mail_params.h	2004-01-21 08:41:03.000000000 +0200
@@ -326,2 +326,6 @@
 
+#define VAR_CANON_ENV_RCPT	"canonicalize_envelope_recipient"
+#define DEF_CANON_ENV_RCPT	1
+extern bool var_canon_env_rcpt;
+
 #define VAR_TRANSPORT_MAPS	"transport_maps"
