# $NetBSD: INSTALL,v 1.1 2004/07/21 22:35:59 schmonz Exp $

DOCDIR=@DOCDIR@
EGDIR=@EGDIR@
SHAREDIR=@SHAREDIR@
QMAILDIR=@QMAILDIR@
QMAIL_AUTOCONFIG=@QMAIL_AUTOCONFIG@
QMAIL_QUEUE_DIR=@QMAIL_QUEUE_DIR@
QMAIL_QUEUE_EXTRA=@QMAIL_QUEUE_EXTRA@

VAR_QMAIL_DIRS="alias bin boot control doc man queue users"

case ${STAGE} in

PRE-INSTALL)
	for dir in $VAR_QMAIL_DIRS; do
		if [ -e ${QMAILDIR}/$dir ]; then
			${CAT} <<EOF
===========================================================================

ERROR: ${QMAILDIR} exists and is non-empty.

Please remove or rename it, then try again.

===========================================================================
EOF
		exit 1
		fi
	done

	if ${ECHO} ${QMAIL_QUEUE_DIR} | ${GREP} -q "^${QMAILDIR}/"; then
		${CAT} <<EOF
===========================================================================

ERROR: QMAIL_QUEUE_DIR must not be under ${QMAILDIR}.

Please adjust your definition of QMAIL_QUEUE_DIR, then try again.

===========================================================================
EOF
		exit 1
	fi

	${LN} -s ${PKG_SYSCONFDIR}/alias	${QMAILDIR}/alias
	${LN} -s ${PREFIX}/bin			${QMAILDIR}/bin
	${LN} -s ${EGDIR}/boot			${QMAILDIR}/boot
	${LN} -s ${PKG_SYSCONFDIR}/control	${QMAILDIR}/control
	${LN} -s ${DOCDIR}			${QMAILDIR}/doc
	${LN} -s ${PREFIX}/man			${QMAILDIR}/man
	${LN} -s ${QMAIL_QUEUE_DIR}		${QMAILDIR}/queue
	${LN} -s ${PKG_SYSCONFDIR}/users	${QMAILDIR}/users

	;;

POST-INSTALL)
	if [ "${QMAIL_AUTOCONFIG}" = YES ]; then

		cd ${SHAREDIR}/setup && ./config-fast `./hostname`

		cd ${PKG_SYSCONFDIR}/alias && ${TOUCH} .qmail-postmaster .qmail-mailer-daemon .qmail-root

		if ! [ -s ${PKG_SYSCONFDIR}/control/concurrencyincoming ]; then
			${ECHO} 20 > ${PKG_SYSCONFDIR}/control/concurrencyincoming
			${CHMOD} 644 ${PKG_SYSCONFDIR}/control/concurrencyincoming
		fi

		if ! [ -s ${PKG_SYSCONFDIR}/control/defaultdelivery ]; then
			${ECHO} ./Mailbox > ${PKG_SYSCONFDIR}/control/defaultdelivery
			${CHMOD} 644 ${PKG_SYSCONFDIR}/control/defaultdelivery
		fi

		pop3rule=':allow'
		smtprule='127.:allow,RELAYCLIENT=""'
		for i in pop3 smtp; do
			if ! [ -s ${PKG_SYSCONFDIR}/tcp.${i} ]; then
				eval ${ECHO} \"\$${i}rule\" > ${PKG_SYSCONFDIR}/tcp.${i}
			fi
			${CHMOD} 644 ${PKG_SYSCONFDIR}/tcp.${i}
			${LOCALBASE}/bin/tcprules ${PKG_SYSCONFDIR}/tcp.${i}.cdb ${PKG_SYSCONFDIR}/tcp.${i}.tmp < ${PKG_SYSCONFDIR}/tcp.${i}
			${CHMOD} 644 ${PKG_SYSCONFDIR}/tcp.${i}.cdb
		done

		if ! [ -z ${QMAIL_QUEUE_EXTRA} ]; then
			${ECHO} '#' >> ${PKG_SYSCONFDIR}/alias/.qmail-${QMAIL_QUEUE_EXTRA}
			${CHMOD} 644 ${PKG_SYSCONFDIR}/alias/.qmail-${QMAIL_QUEUE_EXTRA}
		fi

	else
		${CAT} <<EOF
===========================================================================

You may need to create some config files manually.

===========================================================================
EOF
	fi

	;;

esac
