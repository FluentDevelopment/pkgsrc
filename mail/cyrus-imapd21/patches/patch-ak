--- imap/ctl_cyrusdb.c.orig	Wed May 29 12:49:14 2002
+++ imap/ctl_cyrusdb.c	Tue Jan  7 13:03:45 2003
@@ -231,9 +231,9 @@
 
     /* create the names of the backup directories */
     strcpy(backup1, dirname);
-    strcat(backup1, ".backup1/");
+    strcat(backup1, ".backup1");
     strcpy(backup2, dirname);
-    strcat(backup2, ".backup2/");
+    strcat(backup2, ".backup2");
 
     syslog(LOG_NOTICE, "%s", msg);
 
@@ -274,7 +274,7 @@
 	    r2 = (dblist[i].env)->sync();
 	    if (r2) {
 		syslog(LOG_ERR, "DBERROR: sync %s: %s", dirname,
-		       cyrusdb_strerror(r));
+		       cyrusdb_strerror(r2));
 		fprintf(stderr, 
 			"ctl_cyrusdb: unable to sync environment\n");
 	    }
@@ -289,6 +289,7 @@
 		struct dirent *dirent;
 
 		tail = backup2 + strlen(backup2);
+		*tail++ = '/';
 
 		/* remove db.backup2 */
 		dirp = opendir(backup2);
@@ -302,7 +303,7 @@
 
 		    closedir(dirp);
 		}
-		*tail = '\0';
+		tail[-1] = '\0';
 		r2 = rmdir(backup2);
 
 		/* move db.backup1 to db.backup2 */
@@ -323,7 +324,7 @@
 
 	    if (r2) {
 		syslog(LOG_ERR, "DBERROR: archive %s: %s", dirname,
-		       cyrusdb_strerror(r));
+		       cyrusdb_strerror(r2));
 		fprintf(stderr, 
 			"ctl_cyrusdb: unable to archive environment\n");
 	    }
@@ -342,7 +343,7 @@
 
 	r2 = (dblist[i].env)->done();
 	if (r2) {
-	    syslog(LOG_ERR, "DBERROR: done: %s", cyrusdb_strerror(r));
+	    syslog(LOG_ERR, "DBERROR: done: %s", cyrusdb_strerror(r2));
 	}
     }
 
