$NetBSD: patch-ac,v 1.15 2003/10/01 20:48:31 abs Exp $

--- abcde.orig	Sun May 18 20:01:13 2003
+++ abcde
@@ -337,7 +337,7 @@ do_batch_encode ()
 			do
 				TRACKFILES="$TRACKFILES track$UTRACKNUM.wav"
 			done
-			nice $ENCNICE $ENCODER $ENCODEROPTS --nogap $TRACKFILES
+			nice $ENCNICE $MP3ENCODER $MP3ENCODEROPTS --nogap $TRACKFILES
 			RETURN=$?
 			if [ "$RETURN" != "0" ]; then
 				echo "batch-encode: $ENCODER returned code $RETURN" >> errors
@@ -928,7 +928,12 @@ do_cddbedit ()
 		echo "abcde: internal error: cddb-choice not recorded." >&2
 		exit 1
 	fi
+
+	# Strip out ^M
 	CDDBDATA="$ABCDETEMPDIR/cddbread.$(checkstatus cddb-choice)"
+	CDDBDATATMP="$ABCDETEMPDIR/cddbread.tmp"
+	tr -d '\r' < $CDDBDATA > $CDDBDATATMP
+	mv $CDDBDATATMP $CDDBDATA
 
 	if [ "$INTERACTIVE" = "y" ]; then
 		echo -n "Edit selected CDDB data? [y/n] (n): " >&2
@@ -1233,8 +1238,8 @@ if [ -z "$WAVOUTPUTDIR" ]; then
 fi
 
 # Load system defaults
-if [ -r /etc/abcde.conf ]; then
-	. /etc/abcde.conf
+if [ -r @PKG_SYSCONFDIR@/abcde.conf ]; then
+	. @PKG_SYSCONFDIR@/abcde.conf
 fi
 # Load user preference defaults
 if [ -r $HOME/.abcde.conf ]; then
@@ -1260,8 +1265,8 @@ else
 	elif [ -e /dev/acd0c ]; then
 		CDROM=/dev/acd0c
 	else
-		echo "abcde error: CDROM device cannot be found." >&2
-		exit 1
+		RAWPART=`sysctl -n kern.rawpartition | awk '{printf "%c",97+$0}'`
+		CDROM=/dev/rcd0$RAWPART
 	fi
 fi
 
@@ -1308,7 +1313,7 @@ done
 case "$CDROMREADERSYNTAX" in
 	cdparanoia|debug)
 		CDROMREADER="$CDPARANOIA"
-		CDROMREADEROPTS="$CDPARANOIAOPTS"
+		CDROMREADEROPTS="$CDPARANOIAOPTS -g ${CDROM}"
 		;;
 	cdda2wav)
 		CDROMREADER="$CDDA2WAV"
@@ -1427,7 +1432,8 @@ for X in $CDROMREADER $CDDISCID ${NEEDTA
 do
 	# Cut off the command-line options we just added in
 	X=$(echo $X | cut -d' ' -f2)
-	if [ "$(which $X)" = "" ]; then
+	Y="$(which $X | cut -d' ' -f1,2)"
+	if [ "$Y" = "" -o "$Y" = "no $X" ]; then
 		echo "abcde error: $X is not in your path." >&2
 		exit 1
 	elif [ ! -x $(which $X) ]; then
