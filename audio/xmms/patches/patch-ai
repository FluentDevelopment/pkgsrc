$NetBSD: patch-ai,v 1.5 2002/03/21 18:52:31 drochner Exp $

--- xmms/main.c.orig	Wed Feb 27 15:30:28 2002
+++ xmms/main.c	Thu Mar 21 12:58:10 2002
@@ -37,6 +37,23 @@
 #include "libxmms/dirbrowser.h"
 #include "xmms_mini.xpm"
 
+#ifdef __NetBSD__
+#include <gtk/gtk.h>
+#include <pthread.h>
+
+/*
+ * NetBSD uses non-preemptive pth, so we yield the processor periodically
+ */
+
+gint
+pth_nbschedule (gpointer data)
+{
+	pthread_yield_np();
+
+	return TRUE;
+}
+#endif
+
 GtkWidget *mainwin, *mainwin_url_window = NULL, *mainwin_dir_browser = NULL;
 GtkWidget *mainwin_jtt = NULL, *mainwin_jtf = NULL;
 GtkItemFactory *mainwin_options_menu, *mainwin_songname_menu, *mainwin_vis_menu;
@@ -3377,7 +3394,7 @@
 {
 	gchar *filename;
 	struct cmdlineopt options;
-#if defined(HAVE_SCHED_SETSCHEDULER) && defined(HAVE_SCHED_GET_PRIORITY_MAX)
+#if defined(HAVE_SCHED_SETSCHEDULER) && defined(HAVE_SCHED_GET_PRIORITY_MAX) && !defined(__NetBSD__)
 	struct sched_param sparam;
 #endif
 
@@ -3408,7 +3425,7 @@
 
 	if (geteuid() == 0)
 	{
-#if defined(HAVE_SCHED_SETSCHEDULER) && defined(HAVE_SCHED_GET_PRIORITY_MAX)
+#if defined(HAVE_SCHED_SETSCHEDULER) && defined(HAVE_SCHED_GET_PRIORITY_MAX) && !defined(__NetBSD__)
 		if (cfg.use_realtime)
 		{
 			sparam.sched_priority = sched_get_priority_max(SCHED_RR);
@@ -3501,6 +3518,9 @@
 	/* enable_x11r5_session_management(argc, argv); */
 	sm_init(argc, argv);
 	GDK_THREADS_LEAVE();
+#ifdef __NetBSD__
+	gtk_timeout_add (150, pth_nbschedule, NULL);
+#endif
 	gtk_main();
 
 	return 0;
