$NetBSD: patch-ad,v 1.2 2006/02/11 10:03:48 cube Exp $

--- mod_statusbar/ion-statusd/statusd_load.lua.orig	2005-05-02 16:55:27.000000000 +0200
+++ mod_statusbar/ion-statusd/statusd_load.lua
@@ -39,7 +39,7 @@ end
 local function get_load_uptime()
     local f=io.popen('uptime', 'r')
     if not f then
-        return "??"
+        return ""
     end
     local s=f:read('*l')
     f:close()
@@ -47,11 +47,30 @@ local function get_load_uptime()
     return (load or "")
 end
 
+local function get_load_sysctl()
+    local f=io.popen('sysctl -n vm.loadavg', 'r')
+    if not f then
+        return ""
+    end
+    local s=f:read('*l')
+    f:close()
+    local st, en, load=string.find(s, '^\{? ?(%d+%.%d+) %d+%.%d+ %d+%.%d+ ?\}?$')
+    return (load or "")
+end
+
+local function get_load_na()
+    return "(n/a)"
+end
+
 local function detect_load_fn()
     if get_load_proc()~="" then
         return get_load_proc
-    else
+    elseif get_load_uptime()~="" then
         return get_load_uptime
+    elseif get_load_sysctl()~="" then
+        return get_load_sysctl
+    else
+        return get_load_na
     end
 end
 
