$NetBSD: patch-ag,v 1.1 2002/04/15 02:00:04 itojun Exp $

--- isakmp_inf.c.orig	Tue Dec 11 13:39:32 2001
+++ isakmp_inf.c	Mon Apr 15 10:57:48 2002
@@ -1058,10 +1058,13 @@
 		 * racoon only deletes SA which is matched both the
 		 * source address and the destination accress.
 		 */
-		if ((cmpsaddrwop(iph1->local, src)
-		  && cmpsaddrwop(iph1->remote, dst))
-		 || (cmpsaddrwop(iph1->remote, src)
-		  && cmpsaddrwop(iph1->local, dst))) {
+		if (cmpsaddrwop(iph1->local, src) == 0 &&
+		    cmpsaddrwop(iph1->remote, dst) == 0)
+			;
+		else if (cmpsaddrwop(iph1->remote, src) == 0 &&
+		    cmpsaddrwop(iph1->local, dst) == 0)
+			;
+		else {
 			msg = next;
 			continue;
 		}
@@ -1076,8 +1079,10 @@
 			    msg->sadb_msg_satype)
 				break;
 		}
-		if (i == pfkey_nsatypes)
+		if (i == pfkey_nsatypes) {
+			msg = next;
 			continue;
+		}
 
 		plog(LLV_INFO, LOCATION, NULL,
 			"purging spi=%u.\n", ntohl(sa->sadb_sa_spi));
