#! @SH@

# $NetBSD: download-vulnerability-list,v 1.18 2003/09/16 07:21:03 agc Exp $

: ${PKGVULNDIR=@PKGVULNDIR@}

if [ ! -e ${PKGVULNDIR} ]; then
	echo "Creating ${PKGVULNDIR}"
	@MKDIR@ ${PKGVULNDIR} || (echo "Can't create ${PKGVULNDIR}" 1>&2; exit 1)
fi

VUL_SOURCE="ftp://ftp.netbsd.org/pub/NetBSD/packages/distfiles/pkg-vulnerabilities"
NEW_VUL_LIST=pkg-vulnerabilities.$$
EXIST_VUL_LIST=pkg-vulnerabilities

cd ${PKGVULNDIR}
case "@FETCH_CMD@" in
*curl)	@FETCH_CMD@ -o ${NEW_VUL_LIST} ${VUL_SOURCE} ;;
*ftp)	@FETCH_CMD@ -o ${NEW_VUL_LIST} ${VUL_SOURCE} ;;
*wget)	@FETCH_CMD@ -O ${NEW_VUL_LIST} ${VUL_SOURCE} ;;
*)	echo "Unknown fetch command - please use send-pr to send in support for your fetch command" 1>&2
	exit 1
	;;
esac

# see if the file got damaged while it was being downloaded
errmsg=""
recordedsum=`@AWK@ '$1 == "#CHECKSUM" { print $3 }' ${NEW_VUL_LIST}`
recordedalg=`@AWK@ '$1 == "#CHECKSUM" { print $2 }' ${NEW_VUL_LIST}`
case "$recordedsum" in
"")	errmsg="***WARNING*** No checksum found in the downloaded vulnerabilities file"
	;;
*)	case "$recordedalg" in
	"")	errmsg="***WARNING*** No checksum algorithm found in the downloaded vulnerabilities file"
		;;
	*)	calcsum=`@AWK@ '$1 == "#CHECKSUM" || /\$NetBSD.*/ { next } { print }' ${NEW_VUL_LIST} | @DIGEST@ $recordedalg`
		if [ "$recordedsum" != "$calcsum" ]; then
			errmsg="***WARNING*** Checksum mismatch - recorded $recordedalg checksum \"$recordedsum\", calculated checksum \"$calcsum\""
		fi
		;;
	esac
esac
case "$errmsg" in
"")	;;
*)	echo "$errmsg" 1>&2
	@RM@ -f ${NEW_VUL_LIST}
	exit 1
	;;
esac

# test to see if file has been changed
neednew=false
if [ -f ${EXIST_VUL_LIST} ]; then
	oldsum=`@AWK@ '$1 == "#CHECKSUM" { print $3 }' ${EXIST_VUL_LIST}`
	if [ "$oldsum" != "$calcsum" ]; then
		neednew=true
	fi
else
	neednew=true
fi

# if we need the new file, move it into position
if $neednew; then
	echo "Package vulnerabilities file has been updated"
	@CHMOD@ a+r ${NEW_VUL_LIST}
	@MV@ -f ${NEW_VUL_LIST} ${EXIST_VUL_LIST}
else
	echo "No change from existing package vulnerabilities file"
	@RM@ -f ${NEW_VUL_LIST}
fi

exit 0
