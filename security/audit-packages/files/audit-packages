#! @SH@

# $NetBSD: audit-packages,v 1.12 2003/09/03 15:07:00 tron Exp $

: ${PKGVULNDIR=@PKGVULNDIR@}

if [ ! -f ${PKGVULNDIR}/pkg-vulnerabilities ]; then
	echo "** Missing ${PKGVULNDIR}/pkg-vulnerabilities" 1>&2
	echo "** run download-vulnerability-list" 1>&2
	exit 1
fi

if [ -n "$(find ${PKGVULNDIR}/pkg-vulnerabilities -ctime +7)" ]; then
	echo "** ${PKGVULNDIR}/pkg-vulnerabilities more than a week old" 1>&2
	echo "** run download-vulnerability-list" 1>&2
	exit 1
fi

@AWK@ '
	/^#.*/ { next }
	NF == 0 { next }
	{ cmd = sprintf("@PKG_TOOLS_BIN@/pkg_info -qe \"%s\" && echo Package \"`@PKG_TOOLS_BIN@/pkg_info -e '\''%s\'\''`\" has a %s vulnerability, see %s ; wait", $1, $1, $2, $3);
	  system(cmd); }
' ${PKGVULNDIR}/pkg-vulnerabilities

exit 0
