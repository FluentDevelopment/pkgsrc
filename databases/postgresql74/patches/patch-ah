$NetBSD: patch-ah,v 1.1 2005/03/17 22:35:48 jschauma Exp $

--- src/pl/plpgsql/src/gram.y.orig	2005-01-20 19:31:21.000000000 -0500
+++ src/pl/plpgsql/src/gram.y	2005-03-17 17:29:03.000000000 -0500
@@ -1713,6 +1713,15 @@
 		}
 	}
 
+	/* Check for array overflow */
+	if (nparams >= 1024)
+	{
+		plpgsql_error_lineno = lno;
+		ereport(ERROR,
+				(errcode(ERRCODE_PROGRAM_LIMIT_EXCEEDED),
+				errmsg("too many variables specified in SQL statement")));
+	}
+
 	expr = malloc(sizeof(PLpgSQL_expr) + sizeof(int) * nparams - sizeof(int));
 	expr->dtype			= PLPGSQL_DTYPE_EXPR;
 	expr->query			= strdup(plpgsql_dstring_get(&ds));
@@ -1856,6 +1865,15 @@
 
 					while ((tok = yylex()) == ',')
 					{
+						/* Check for array overflow */
+						if (nfields >= 1024)
+						{
+							plpgsql_error_lineno = plpgsql_scanner_lineno();
+							ereport(ERROR,
+									(errcode(ERRCODE_PROGRAM_LIMIT_EXCEEDED),
+									errmsg("too many variables specified in SQL statement")));
+						}
+
 						tok = yylex();
 						switch(tok)
 						{
@@ -1918,6 +1936,15 @@
 				plpgsql_dstring_append(&ds, yytext);
 				break;
 		}
+
+		/* Check for array overflow */
+		if (nparams >= 1024)
+		{
+			plpgsql_error_lineno = plpgsql_scanner_lineno();
+			ereport(ERROR,
+					(errcode(ERRCODE_PROGRAM_LIMIT_EXCEEDED),
+						errmsg("too many variables specified in SQL statement")));
+			}
 	}
 
 	expr = malloc(sizeof(PLpgSQL_expr) + sizeof(int) * nparams - sizeof(int));
@@ -1952,12 +1979,12 @@
 
 		return (PLpgSQL_stmt *)execsql;
 	}
-}
+	}
 
 
-static PLpgSQL_stmt *
-make_fetch_stmt(void)
-{
+	static PLpgSQL_stmt *
+	make_fetch_stmt(void)
+	{
 	int					tok;
 	PLpgSQL_row		   *row = NULL;
 	PLpgSQL_rec		   *rec = NULL;
@@ -1989,6 +2016,15 @@
 
 				while ((tok = yylex()) == ',')
 				{
+						/* Check for array overflow */
+						if (nfields >= 1024)
+						{
+							plpgsql_error_lineno = plpgsql_scanner_lineno();
+							ereport(ERROR,
+									(errcode(ERRCODE_PROGRAM_LIMIT_EXCEEDED),
+									errmsg("too many variables specified in SQL statement")));
+					}
+
 					tok = yylex();
 					switch(tok)
 					{
