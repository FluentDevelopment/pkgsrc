# $NetBSD: Makefile,v 1.3 2006/06/18 08:45:56 rillig Exp $

# Note: Regen distinfo with PKG_DEFAULT_OPTIONS+=sun-jre-jce

DISTNAME=	jre-${DIST_VER}-${DIST_ARCH}
PKGNAME=	scsl-jre15-${PKG_VER}
MASTER_SITES=	# empty

SHORT_NAME=	JRE

WRKSRC=		${WRKDIR}/${DISTNAME:S/-//:S/_/./g:C/-.*$//}
JAVA_WRAPPERS=	java keytool orbd policytool rmid rmiregistry \
		servertool tnameserv
REQD_DIRS=	${JAVA_HOME}
REQD_DIRS+=	${JAVA_HOME}/lib
REQD_DIRS+=	${JAVA_HOME}/lib/applet
REQD_DIRS+=	${JAVA_HOME}/lib/images
REQD_DIRS+=	${JAVA_HOME}/lib/images/cursors
REQD_DIRS+=	${JAVA_HOME}/lib/security
CONF_FILES=	# empty
.sinclude "sfiles.mk"
.for f in ${SFILES}
CONF_FILES+=	${JAVA_HOME}/lib/${f}.default ${JAVA_HOME}/lib/${f}
.endfor

PKG_OPTIONS_VAR=	PKG_OPTIONS.scsl-jre15
PKG_SUPPORTED_OPTIONS=	sun-jre-jce

.include "../../mk/bsd.options.mk"

HEADER_TEMPLATES+=	${WRKDIR}/HEADER.tmpl
INSTALL_TEMPLATES+=	${PKGDIR}/INSTALL.tmpl
DEINSTALL_TEMPLATES+=	${PKGDIR}/DEINSTALL.tmpl
FILES_SUBST+=		JAVA_HOME=${JAVA_HOME:Q}
FILES_SUBST+=		MACHINE_ARCH=${MACHINE_ARCH:Q}

CHECK_FILES_SKIP+=	${JAVA_HOME}/lib/${MACHINE_ARCH}/client/classes.jsa

.if !empty(PKG_OPTIONS:Msun-jre-jce)
DISTFILES=	${DISTNAME}${EXTRACT_SUFX} jce_policy-1_5_0.zip
PLIST_SUBST+=	SCSL_JRE15_USE_JCE=""
.else
PLIST_SUBST+=	SCSL_JRE15_USE_JCE="@comment "
.endif

post-extract:
	${MKDIR} ${WRKSRC}/.systemPrefs
	${TOUCH} ${WRKSRC}/.systemPrefs/.system.lock
	${TOUCH} ${WRKSRC}/.systemPrefs/.systemRootModFile

do-configure:
	set -e;								\
	cd ${WRKSRC}/lib; for file in ${SFILES}; do			\
		${MV} -f "$$file" "$$file".default;			\
	done
	@${ECHO} "CONF_FILES="${CONF_FILES:Q:Q} >${WRKDIR}/HEADER.tmpl

pre-install:
.if !empty(PKG_OPTIONS:Msun-jre-jce)
	cd ${WRKDIR}/jce && ${PAX} -rw -pp -v . ${WRKSRC}/lib/security
.endif

#
# re-create sfiles.mk from properties and config files
#
.PHONY: makesfiles
makesfiles:
	${ECHO} >  sfiles.mk '#	$$Net''BSD$$'
	${ECHO} >> sfiles.mk '#'
	${ECHO} >> sfiles.mk '# Created with "make makesfiles"'
	${ECHO} >> sfiles.mk '# Do not edit this file manually!'
	${ECHO} >> sfiles.mk '#'
	cd ${WRKSRC}/lib && ${FIND} * -name fontconfig.\* -o		\
		-name \*.properties -o -name \*.properties.\?\? -o	\
		-name \*.cfg -o -name \*.security |			\
	${SED} 's/^/SFILES+=	/' >>${PKGDIR}/sfiles.mk

.include "../../lang/scsl-jre15/Makefile.common"
